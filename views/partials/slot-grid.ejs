<%# Expects: slots, players, voteMap, slotSummary, preferenceMap, allUsersMap (optional), unavailabilityMap (optional) %>
<div class="slot-grid-wrapper">
  <table class="slot-grid">
    <thead>
      <tr>
        <th class="grid-corner">Adventurer</th>
        <% for (const slot of slots) { %>
          <th class="grid-slot-header">
            <div class="slot-date"><%= formatDate(slot.date_time, { weekday: 'short', month: 'short', day: 'numeric', showTime: false }) %></div>
            <div class="slot-time"><%= formatTime(slot.date_time) %></div>
            <% if (slot.label) { %><div class="slot-label"><%= slot.label %></div><% } %>
          </th>
        <% } %>
      </tr>
    </thead>
    <tbody>
      <% for (const player of players) { %>
        <tr>
          <td class="grid-player">
            <% if (typeof allUsersMap !== 'undefined' && allUsersMap[player.id] && allUsersMap[player.id].avatar) { %>
              <img src="/avatars/<%= allUsersMap[player.id].avatar %>" alt="" class="avatar-tiny">
            <% } else { %>
              <span class="avatar-letter avatar-letter-sm"><%= player.username.charAt(0).toUpperCase() %></span>
            <% } %>
            <%= player.username %>
          </td>
          <% for (const slot of slots) { %>
            <% const status = (voteMap[slot.id] && voteMap[slot.id][player.id]) || 'none'; %>
            <td class="grid-cell vote-<%= status %>">
              <% if (status === 'available') { %>
                &#10003;
              <% } else if (status === 'maybe') { %>
                ?
              <% } else if (status === 'unavailable') { %>
                &#10007;
              <% } else { %>
                &mdash;
              <% } %>
            </td>
          <% } %>
        </tr>
      <% } %>
    </tbody>
    <tfoot>
      <tr class="summary-row">
        <td class="grid-player"><strong>Available</strong></td>
        <% for (const slot of slots) { %>
          <td class="grid-cell summary-cell">
            <span class="summary-available"><%= slotSummary[slot.id].available %></span>
            <% if (slotSummary[slot.id].maybe > 0) { %>
              / <span class="summary-maybe"><%= slotSummary[slot.id].maybe %>?</span>
            <% } %>
          </td>
        <% } %>
      </tr>
      <% if (typeof preferenceMap !== 'undefined' && Object.keys(preferenceMap).length > 0) { %>
        <tr class="summary-row">
          <td class="grid-player"><strong>DM Pref</strong></td>
          <% for (const slot of slots) { %>
            <td class="grid-cell summary-cell">
              <% const prefUsers = Object.values(preferenceMap).filter(p => p.slot_id === slot.id); %>
              <% if (prefUsers.length > 0) { %>
                <span class="preference-star" title="<%= prefUsers.map(p => p.username).join(', ') %>">&#9733;</span>
              <% } else { %>
                &mdash;
              <% } %>
            </td>
          <% } %>
        </tr>
      <% } %>
      <% if (typeof unavailabilityMap !== 'undefined') { %>
        <% const hasAny = slots.some(s => { const d = s.date_time.split('T')[0]; return unavailabilityMap[d] && unavailabilityMap[d].length > 0; }); %>
        <% if (hasAny) { %>
          <tr class="summary-row unavail-row">
            <td class="grid-player"><strong>Unavail</strong></td>
            <% for (const slot of slots) { %>
              <% const slotDate = slot.date_time.split('T')[0]; %>
              <% const unavails = unavailabilityMap[slotDate] || []; %>
              <td class="grid-cell summary-cell">
                <% if (unavails.length > 0) { %>
                  <span class="unavail-warning" title="<%= unavails.map(u => u.username + (u.reason ? ': ' + u.reason : '')).join('\n') %>">&#9888; <%= unavails.length %></span>
                <% } else { %>
                  &mdash;
                <% } %>
              </td>
            <% } %>
          </tr>
        <% } %>
      <% } %>
    </tfoot>
  </table>
</div>
