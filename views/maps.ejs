<%- include('partials/head', { pageTitle: 'Maps' }) %>

<div class="page-header">
  <h1>Maps</h1>
  <div>
    <% if (isDM) { %>
      <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('create-map-form').style.display = document.getElementById('create-map-form').style.display === 'none' ? 'block' : 'none'">+ New Map</button>
    <% } %>
    <a href="/" class="btn btn-outline btn-small">Back to Chamber</a>
  </div>
</div>

<% if (isDM) { %>
  <div id="create-map-form" style="display:none; margin-bottom: 1rem;">
    <div class="card" style="border: 1px solid var(--gold-dim);">
      <h3>Create Map</h3>
      <form action="/map" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div class="form-group">
          <label for="map_name">Map Name</label>
          <input type="text" name="name" id="map_name" required placeholder="e.g. World Map, Dungeon Level 1, Town of Phandalin">
        </div>
        <div class="form-group">
          <label for="map_type">Map Type</label>
          <select name="map_type" id="map_type">
            <% for (const [key, val] of Object.entries(MARKER_TYPES)) { %>
              <option value="<%= key %>"><%= val.icon %> <%= val.label %></option>
            <% } %>
          </select>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button type="submit" class="btn btn-primary btn-small">Create</button>
          <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('create-map-form').style.display='none'">Cancel</button>
        </div>
      </form>
    </div>
  </div>
<% } %>

<% if (tree.length === 0) { %>
  <div class="card">
    <p class="empty-state-text">No maps yet.<% if (isDM) { %> Create one above to get started.<% } %></p>
  </div>
<% } else { %>
  <div class="card">
    <% function renderMapNode(node, level) { %>
      <div class="maps-tree-item<%= level > 0 ? ' maps-tree-child' : '' %>" style="<%= level > 0 ? 'margin-left: ' + (level * 1.5) + 'rem;' : '' %>">
        <div class="maps-tree-row">
          <div class="maps-tree-thumb">
            <% if (node.image_path) { %>
              <a href="/map/<%= node.id %>"><img src="/maps/<%= node.image_path %>" alt=""></a>
            <% } else { %>
              <a href="/map/<%= node.id %>">
                <div class="maps-tree-placeholder">
                  <span><%= MARKER_TYPES[node.map_type] ? MARKER_TYPES[node.map_type].icon : 'ðŸŒ' %></span>
                </div>
              </a>
            <% } %>
          </div>
          <div class="maps-tree-info">
            <a href="/map/<%= node.id %>" class="maps-tree-name"><%= node.name %></a>
            <div class="maps-tree-meta">
              <span class="map-type-badge map-type-<%= node.map_type %>"><%= MARKER_TYPES[node.map_type] ? MARKER_TYPES[node.map_type].icon : 'ðŸŒ' %> <%= MARKER_TYPES[node.map_type] ? MARKER_TYPES[node.map_type].label : node.map_type %></span>
              <% if (node.children && node.children.length > 0) { %>
                <span class="text-muted" style="font-size: 0.8rem;"><%= node.children.length %> sub-map<%= node.children.length !== 1 ? 's' : '' %></span>
              <% } %>
            </div>
          </div>
          <% if (isDM) { %>
            <div class="maps-tree-actions">
              <form action="/map/<%= node.id %>/delete" method="POST" class="inline-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Delete this map<%= node.children && node.children.length > 0 ? ' and all sub-maps' : '' %>?')">&times;</button>
              </form>
            </div>
          <% } %>
        </div>
      </div>
      <% if (node.children && node.children.length > 0) { %>
        <% for (const child of node.children) { %>
          <% renderMapNode(child, level + 1); %>
        <% } %>
      <% } %>
    <% } %>

    <% for (const root of tree) { %>
      <% renderMapNode(root, 0); %>
    <% } %>
  </div>
<% } %>

<%- include('partials/foot') %>
