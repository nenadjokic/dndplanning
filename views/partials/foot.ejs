  </main>

  <!-- Toast Notification Container (Phase 3) -->
  <div class="toast-container" id="toast-container"></div>

  <footer class="app-footer">
    <div class="container">
      <% if (typeof user !== 'undefined' && user) { %>
        <div class="footer-players" id="active-players"></div>
      <% } %>
      <div class="footer-about">
        <strong>Quest Planner</strong> v<%= appVersion %> &mdash; Open-source D&D session scheduler
      </div>
      <div class="footer-links">
        <a href="https://github.com/nenadjokic/dndplanning" target="_blank">GitHub</a>
        <span class="footer-sep">&middot;</span>
        <a href="https://www.gnu.org/licenses/gpl-3.0.html" target="_blank">GPL-3.0 License</a>
        <span class="footer-sep">&middot;</span>
        <a href="https://buymeacoffee.com/nenadjokic" target="_blank">Buy Me a Coffee</a>
        <span class="footer-sep">&middot;</span>
        <a href="https://paypal.me/nenadjokicRS" target="_blank">PayPal</a>
      </div>
      <div class="footer-copy">
        Made with &hearts; by Nenad Jokic
      </div>
    </div>
  </footer>

  <% if (typeof showWhatsNew !== 'undefined' && showWhatsNew) { %>
    <div class="welcome-overlay" id="whatsnew-overlay">
      <div class="welcome-modal whatsnew-modal">
        <h2>What's New in v<%= appVersion %> ğŸ—ºï¸</h2>
        <div class="whatsnew-content">
          <h3 style="color: var(--gold); font-size: 0.95rem; margin-bottom: 0.5rem;">NPC Token System</h3>
          <ul class="whatsnew-list">
            <li><strong>ğŸ‘¹ NPC Library</strong> &mdash; Create and manage NPCs with categories, HP, avatar, and notes</li>
            <li><strong>ğŸ“š Import from Vault</strong> &mdash; Search Bestiary (2200+ monsters), Races, or Classes to auto-fill NPC stats and HP</li>
            <li><strong>â¤ï¸ HP Tracker</strong> &mdash; Delta-based HP calculator (+15 / -33), color-coded HP bar (green/yellow/red)</li>
            <li><strong>ğŸ‘ï¸ Hide/Reveal NPCs</strong> &mdash; Toggle NPC visibility for players in real-time</li>
          </ul>
          <h3 style="color: var(--gold); font-size: 0.95rem; margin-bottom: 0.5rem; margin-top: 1rem;">Fog of War</h3>
          <ul class="whatsnew-list">
            <li><strong>ğŸŒ«ï¸ FoW Canvas Overlay</strong> &mdash; Full-map fog that hides unexplored areas from players</li>
            <li><strong>ğŸ–Œï¸ Reveal/Hide Brush</strong> &mdash; Paint to reveal or re-hide areas with adjustable brush size</li>
            <li><strong>ğŸ“¡ Draft &amp; Publish</strong> &mdash; DM paints changes, then publishes to players instantly via SSE</li>
            <li><strong>ğŸ”’ NPCs Under Fog</strong> &mdash; NPC tokens hidden by fog are invisible to players</li>
          </ul>
          <h3 style="color: var(--gold); font-size: 0.95rem; margin-bottom: 0.5rem; margin-top: 1rem;">Map Improvements</h3>
          <ul class="whatsnew-list">
            <li><strong>ğŸ”— Drag &amp; Drop Reparenting</strong> &mdash; Drag standalone maps onto others to create sub-maps</li>
            <li><strong>ğŸ“Œ Link Existing Maps</strong> &mdash; Link an existing map as a sub-map from any pin</li>
            <li><strong>ğŸ–¼ï¸ Aspect Ratio Fix</strong> &mdash; Maps now preserve their natural image dimensions</li>
            <li><strong>ğŸ”’ Hidden Maps</strong> &mdash; DMs can hide maps from players; admins see placeholders</li>
            <li><strong>ğŸ“¡ Real-Time Tokens</strong> &mdash; Token moves, NPC changes, and placements sync instantly across all players</li>
            <li><strong>ğŸ–¥ï¸ Fullscreen Toolbar</strong> &mdash; Tokens, NPCs, Scale, and Fog controls available in fullscreen mode</li>
          </ul>
        </div>
        <div class="whatsnew-links">
          <a href="https://github.com/nenadjokic/dndplanning/releases" target="_blank" rel="noopener noreferrer" class="btn btn-outline btn-small">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
            Full Changelog
          </a>
        </div>
        <p style="margin-top: 1rem; margin-bottom: 0.5rem; color: var(--text-secondary);">Enjoy Quest Planner? Support the project:</p>
        <div class="whatsnew-support">
          <a href="https://buymeacoffee.com/nenadjokic" target="_blank" rel="noopener noreferrer">
            <img src="https://img.shields.io/badge/Buy%20Me%20a%20Coffee-ffdd00?style=for-the-badge&logo=buy-me-a-coffee&logoColor=black" alt="Buy Me a Coffee">
          </a>
          <a href="https://paypal.me/nenadjokicRS" target="_blank" rel="noopener noreferrer">
            <img src="https://img.shields.io/badge/PayPal-00457C?style=for-the-badge&logo=paypal&logoColor=white" alt="PayPal">
          </a>
        </div>
        <button class="btn btn-outline" id="whatsnew-close" style="margin-top: 1rem;">Continue to Quest Planner</button>
      </div>
    </div>
    <script>
      document.getElementById('whatsnew-close').addEventListener('click', function() {
        document.getElementById('whatsnew-overlay').remove();
      });
      document.getElementById('whatsnew-overlay').addEventListener('click', function(e) {
        if (e.target === this) this.remove();
      });
    </script>
  <% } %>

  <% if (typeof firstLogin !== 'undefined' && firstLogin) { %>
    <div class="welcome-overlay" id="welcome-overlay">
      <div class="welcome-modal">
        <h2>Welcome to Quest Planner!</h2>
        <p>Thank you for using this software! Quest Planner is free and open-source, licensed under the GPL-3.0.</p>
        <p>If you enjoy it and would like to support development, consider buying me a coffee:</p>
        <div class="welcome-links">
          <a href="https://buymeacoffee.com/nenadjokic" target="_blank" class="btn btn-primary btn-small">Buy Me a Coffee</a>
          <a href="https://paypal.me/nenadjokicRS" target="_blank" class="btn btn-outline btn-small">PayPal</a>
        </div>
        <p class="form-hint">You can always find these links in the footer.</p>
        <div style="text-align: center; margin: 1rem 0;">
          <img src="/icons/icon-192.png" alt="Quest Planner" style="width: 80px; height: 80px; border-radius: 12px;">
        </div>
        <button class="btn btn-outline" id="welcome-close">Enter the Tavern</button>
      </div>
    </div>
    <script>
      document.getElementById('welcome-close').addEventListener('click', function() {
        document.getElementById('welcome-overlay').remove();
      });
      document.getElementById('welcome-overlay').addEventListener('click', function(e) {
        if (e.target === this) this.remove();
      });
    </script>
  <% } %>

  <script src="/js/toast.js?v=<%= appVersion %>"></script>
  <script src="/js/datetime-picker.js?v=<%= appVersion %>"></script>
  <script src="/js/menu.js?v=<%= appVersion %>"></script>
  <script src="/js/app.js?v=<%= appVersion %>"></script>
  <script src="/js/dnd-modals.js?v=<%= appVersion %>"></script>
  <% if (typeof user !== 'undefined' && user) { %>
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <link rel="stylesheet" href="/css/dice-roller.css?v=<%= appVersion %>">
    <script src="/js/dice-geometry.js?v=<%= appVersion %>"></script>
    <script src="/js/dice-themes.js?v=<%= appVersion %>"></script>
    <script type="module" src="/js/dice-roller.js?v=<%= appVersion %>"></script>
  <% } %>
</body>
</html>
