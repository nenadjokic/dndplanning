<%- include('../partials/head', { pageTitle: 'DM Tools' }) %>

<div class="page-header">
  <h1>DM Tools</h1>
  <div>
    <button type="button" class="btn btn-primary btn-small" onclick="document.getElementById('add-tool-form').style.display = document.getElementById('add-tool-form').style.display === 'none' ? 'block' : 'none'">+ Add Tool</button>
    <a href="/" class="btn btn-outline btn-small">Back to Chamber</a>
  </div>
</div>

<div id="add-tool-form" style="display: none; margin-bottom: 1.5rem;">
  <div class="card">
    <h3>Add New Tool</h3>
    <form action="/dm-tools" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
        <div class="form-group">
          <label for="tool-name">Button Name</label>
          <input type="text" name="name" id="tool-name" required placeholder="D&D Beyond">
        </div>
        <div class="form-group">
          <label for="tool-icon">Icon</label>
          <select name="icon" id="tool-icon">
            <option value="link">Link</option>
            <option value="dice">Dice</option>
            <option value="scroll">Scroll</option>
            <option value="book">Book</option>
            <option value="music">Music</option>
            <option value="map">Map</option>
            <option value="sword">Sword</option>
            <option value="shield">Shield</option>
            <option value="potion">Potion</option>
            <option value="skull">Skull</option>
            <option value="dragon">Dragon</option>
            <option value="wand">Wand</option>
            <option value="gem">Gem</option>
            <option value="crown">Crown</option>
            <option value="hammer">Hammer</option>
            <option value="eye">Eye</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="tool-url">URL</label>
        <input type="url" name="url" id="tool-url" required placeholder="https://www.dndbeyond.com">
      </div>
      <div class="form-group">
        <label for="tool-thumb">Thumbnail (optional, replaces icon)</label>
        <input type="file" name="thumbnail" id="tool-thumb" accept="image/*">
        <small class="form-hint">JPG, PNG, GIF, WebP &mdash; max 2MB. Will be center-cropped to 128&times;128.</small>
      </div>
      <div class="form-group">
        <label>Or fetch favicon from URL</label>
        <input type="hidden" name="favicon_file" id="add-favicon-file">
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button type="button" class="btn btn-outline btn-small" onclick="fetchFavicon('add')">Fetch Favicon</button>
          <span id="add-favicon-status" class="form-hint"></span>
        </div>
        <div id="add-favicon-preview" style="display:none; margin-top:0.5rem;">
          <img id="add-favicon-img" src="" alt="" style="width:32px; height:32px; object-fit:cover; border-radius:4px; border:1px solid var(--border);">
          <button type="button" class="btn btn-small btn-outline" style="margin-left:0.5rem; font-size:0.75rem;" onclick="clearFavicon('add')">Remove</button>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary btn-small">Add Tool</button>
        <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('add-tool-form').style.display='none'">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="dm-tools-size-bar">
  <span class="dm-tools-size-label">Grid size:</span>
  <button type="button" class="dm-tools-size-btn" data-size="16" title="16&times;16">
    <svg width="14" height="14" viewBox="0 0 14 14"><rect x="1" y="1" width="5" height="5" rx="1" fill="currentColor"/><rect x="8" y="1" width="5" height="5" rx="1" fill="currentColor"/><rect x="1" y="8" width="5" height="5" rx="1" fill="currentColor"/><rect x="8" y="8" width="5" height="5" rx="1" fill="currentColor"/></svg>
  </button>
  <button type="button" class="dm-tools-size-btn" data-size="32" title="32&times;32">
    <svg width="14" height="14" viewBox="0 0 14 14"><rect x="0" y="0" width="6" height="6" rx="1" fill="currentColor"/><rect x="8" y="0" width="6" height="6" rx="1" fill="currentColor"/><rect x="0" y="8" width="6" height="6" rx="1" fill="currentColor"/><rect x="8" y="8" width="6" height="6" rx="1" fill="currentColor"/></svg>
  </button>
  <button type="button" class="dm-tools-size-btn" data-size="64" title="64&times;64">
    <svg width="16" height="16" viewBox="0 0 16 16"><rect x="0" y="0" width="7" height="7" rx="1.5" fill="currentColor"/><rect x="9" y="0" width="7" height="7" rx="1.5" fill="currentColor"/><rect x="0" y="9" width="7" height="7" rx="1.5" fill="currentColor"/><rect x="9" y="9" width="7" height="7" rx="1.5" fill="currentColor"/></svg>
  </button>
  <button type="button" class="dm-tools-size-btn" data-size="128" title="128&times;128">
    <svg width="18" height="18" viewBox="0 0 18 18"><rect x="0" y="0" width="8" height="8" rx="2" fill="currentColor"/><rect x="10" y="0" width="8" height="8" rx="2" fill="currentColor"/><rect x="0" y="10" width="8" height="8" rx="2" fill="currentColor"/><rect x="10" y="10" width="8" height="8" rx="2" fill="currentColor"/></svg>
  </button>
</div>

<%
  var toolIcons = {
    link: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>',
    dice: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="3"></rect><circle cx="8" cy="8" r="1.5" fill="currentColor"></circle><circle cx="16" cy="8" r="1.5" fill="currentColor"></circle><circle cx="8" cy="16" r="1.5" fill="currentColor"></circle><circle cx="16" cy="16" r="1.5" fill="currentColor"></circle><circle cx="12" cy="12" r="1.5" fill="currentColor"></circle></svg>',
    scroll: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>',
    book: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>',
    music: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>',
    map: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>',
    sword: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="20" x2="20" y2="4"></line><path d="M15 4h5v5"></path><path d="M4 20l4-4"></path><line x1="2" y1="18" x2="6" y2="22"></line></svg>',
    shield: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',
    potion: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2h8v4l4 10a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4L8 6V2z"></path><line x1="10" y1="2" x2="14" y2="2"></line></svg>',
    skull: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="10" r="8"></circle><circle cx="9" cy="9" r="1.5" fill="currentColor"></circle><circle cx="15" cy="9" r="1.5" fill="currentColor"></circle><path d="M9 18v4"></path><path d="M15 18v4"></path><path d="M12 18v4"></path></svg>',
    dragon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"></path><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>',
    wand: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 4V2"></path><path d="M15 16v-2"></path><path d="M8 9h2"></path><path d="M20 9h2"></path><path d="M17.8 11.8L19 13"></path><path d="M15 9h0"></path><path d="M17.8 6.2L19 5"></path><path d="M3 21l9-9"></path><path d="M12.2 6.2L11 5"></path></svg>',
    gem: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 9 12 22 22 9"></polygon><line x1="2" y1="9" x2="22" y2="9"></line><line x1="12" y1="2" x2="7" y2="9"></line><line x1="12" y1="2" x2="17" y2="9"></line><line x1="7" y1="9" x2="12" y2="22"></line><line x1="17" y1="9" x2="12" y2="22"></line></svg>',
    crown: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18l3-12 5 6 2-8 2 8 5-6 3 12z"></path><path d="M2 18h20"></path></svg>',
    hammer: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 12l-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"></path><path d="M17.64 15L22 10.64"></path><path d="M20.91 11.7l-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V6.5L14.5 2.23 12 4.73V6.5l-2 2h1.5c.85 0 1.65.33 2.25.93l1.25 1.25"></path></svg>',
    eye: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'
  };
%>

<% if (tools.length > 0) { %>
  <div class="dm-tools-grid" id="dm-tools-grid">
    <% for (const tool of tools) { %>
      <div class="dm-tool-card">
        <a href="<%= tool.url %>" target="_blank" rel="noopener noreferrer" class="dm-tool-link">
          <% if (tool.thumbnail) { %>
            <img src="/thumbnails/<%= tool.thumbnail %>" alt="" class="dm-tool-thumb">
          <% } else { %>
            <div class="dm-tool-icon"><%- toolIcons[tool.icon] || toolIcons.link %></div>
          <% } %>
          <div class="dm-tool-name"><%= tool.name %></div>
        </a>
        <div class="dm-tool-actions">
          <button type="button" class="btn btn-small btn-outline" data-edit-tool="<%= tool.id %>">Edit</button>
          <form action="/dm-tools/<%= tool.id %>/delete" method="POST" class="inline-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Remove this tool?')">&times;</button>
          </form>
        </div>
      </div>
    <% } %>
  </div>
<% } else { %>
  <div class="card empty-state">
    <p class="empty-state-text">Your tool board is empty. Add external tools, generators, music players, or any resource you use during sessions!</p>
  </div>
<% } %>

<div id="edit-tool-modal" class="map-add-form" style="display:none;">
  <div class="card" style="max-width: 400px; margin: 0 auto;">
    <h3>Edit Tool</h3>
    <form id="edit-tool-form" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="form-group">
        <label for="edit-tool-name">Button Name</label>
        <input type="text" name="name" id="edit-tool-name" required>
      </div>
      <div class="form-group">
        <label for="edit-tool-icon">Icon</label>
        <select name="icon" id="edit-tool-icon">
          <option value="link">Link</option>
          <option value="dice">Dice</option>
          <option value="scroll">Scroll</option>
          <option value="book">Book</option>
          <option value="music">Music</option>
          <option value="map">Map</option>
          <option value="sword">Sword</option>
          <option value="shield">Shield</option>
          <option value="potion">Potion</option>
          <option value="skull">Skull</option>
          <option value="dragon">Dragon</option>
          <option value="wand">Wand</option>
          <option value="gem">Gem</option>
          <option value="crown">Crown</option>
          <option value="hammer">Hammer</option>
          <option value="eye">Eye</option>
        </select>
      </div>
      <div class="form-group">
        <label for="edit-tool-url">URL</label>
        <input type="url" name="url" id="edit-tool-url" required>
      </div>
      <div class="form-group">
        <label for="edit-tool-thumb">Thumbnail</label>
        <div id="edit-thumb-preview" style="display:none; margin-bottom:0.5rem;">
          <img id="edit-thumb-img" src="" alt="" style="width:48px; height:48px; object-fit:cover; border-radius:8px; border:1px solid var(--border);">
          <label style="display:inline-flex; align-items:center; gap:0.25rem; margin-left:0.5rem; font-weight:normal; font-size:0.85rem; cursor:pointer;">
            <input type="checkbox" name="remove_thumbnail" value="1" id="edit-remove-thumb"> Remove
          </label>
        </div>
        <input type="file" name="thumbnail" id="edit-tool-thumb" accept="image/*">
        <small class="form-hint">Upload new image to replace, or check "Remove" to use icon instead. Cropped to 128&times;128.</small>
      </div>
      <div class="form-group">
        <label>Or fetch favicon from URL</label>
        <input type="hidden" name="favicon_file" id="edit-favicon-file">
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button type="button" class="btn btn-outline btn-small" onclick="fetchFavicon('edit')">Fetch Favicon</button>
          <span id="edit-favicon-status" class="form-hint"></span>
        </div>
        <div id="edit-favicon-preview" style="display:none; margin-top:0.5rem;">
          <img id="edit-favicon-img" src="" alt="" style="width:32px; height:32px; object-fit:cover; border-radius:4px; border:1px solid var(--border);">
          <button type="button" class="btn btn-small btn-outline" style="margin-left:0.5rem; font-size:0.75rem;" onclick="clearFavicon('edit')">Remove</button>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary btn-small">Save</button>
        <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('edit-tool-modal').style.display='none'">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
var toolsData = <%- JSON.stringify(tools.map(function(t) { return { id: t.id, name: t.name, url: t.url, icon: t.icon, thumbnail: t.thumbnail }; })) %>;
var toolsById = {};
toolsData.forEach(function(t) { toolsById[t.id] = t; });

document.addEventListener('click', function(e) {
  var btn = e.target.closest('[data-edit-tool]');
  if (btn) {
    var id = parseInt(btn.getAttribute('data-edit-tool'), 10);
    var t = toolsById[id];
    if (!t) return;
    document.getElementById('edit-tool-form').action = '/dm-tools/' + id + '/edit';
    document.getElementById('edit-tool-name').value = t.name;
    document.getElementById('edit-tool-url').value = t.url;
    document.getElementById('edit-tool-icon').value = t.icon;
    document.getElementById('edit-remove-thumb').checked = false;
    if (t.thumbnail) {
      document.getElementById('edit-thumb-preview').style.display = 'block';
      document.getElementById('edit-thumb-img').src = '/thumbnails/' + t.thumbnail;
    } else {
      document.getElementById('edit-thumb-preview').style.display = 'none';
    }
    document.getElementById('edit-tool-modal').style.display = 'block';
  }
});

// Favicon fetching
function fetchFavicon(prefix) {
  var urlInput = prefix === 'add' ? document.getElementById('tool-url') : document.getElementById('edit-tool-url');
  var url = urlInput ? urlInput.value : '';
  if (!url) {
    if (window.Toast) {
      window.Toast.info('Enter the tool URL first.');
    } else {
      alert('Enter the tool URL first.');
    }
    return;
  }
  var status = document.getElementById(prefix + '-favicon-status');
  status.textContent = 'Fetching...';
  fetch('/dm-tools/fetch-favicon', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url: url })
  }).then(function(r) { return r.json(); }).then(function(data) {
    if (data.success) {
      document.getElementById(prefix + '-favicon-file').value = data.filename;
      document.getElementById(prefix + '-favicon-img').src = '/thumbnails/' + data.filename;
      document.getElementById(prefix + '-favicon-preview').style.display = 'block';
      status.textContent = 'Favicon fetched!';
    } else {
      status.textContent = data.error || 'Failed to fetch favicon';
    }
  }).catch(function() {
    status.textContent = 'Failed to fetch favicon';
  });
}

function clearFavicon(prefix) {
  document.getElementById(prefix + '-favicon-file').value = '';
  document.getElementById(prefix + '-favicon-preview').style.display = 'none';
  document.getElementById(prefix + '-favicon-status').textContent = '';
}

// Grid size selector
(function() {
  var grid = document.getElementById('dm-tools-grid');
  var buttons = document.querySelectorAll('.dm-tools-size-btn');
  var saved = localStorage.getItem('dm-tools-grid-size') || '64';

  function applySize(size) {
    if (!grid) return;
    grid.className = 'dm-tools-grid dm-tools-size-' + size;
    buttons.forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-size') === size);
    });
    localStorage.setItem('dm-tools-grid-size', size);
  }

  applySize(saved);

  buttons.forEach(function(b) {
    b.addEventListener('click', function() {
      applySize(this.getAttribute('data-size'));
    });
  });
})();
</script>

<%- include('../partials/foot') %>
