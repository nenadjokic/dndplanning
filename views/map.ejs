<%- include('partials/head', { pageTitle: 'World Map' }) %>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="page-header">
  <h1>World Map</h1>
  <div>
    <% if (isDM) { %>
      <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('upload-form').style.display = document.getElementById('upload-form').style.display === 'none' ? 'block' : 'none'">Upload Map</button>
    <% } %>
    <a href="/" class="btn btn-outline btn-small">Back to Chamber</a>
  </div>
</div>

<% if (isDM) { %>
  <div id="upload-form" style="display:none; margin-bottom: 1rem;">
    <div class="card">
      <form action="/map/upload" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="map_image">Map Image (JPG, PNG, GIF, WebP &mdash; max 5MB)</label>
          <input type="file" name="map_image" id="map_image" accept="image/*">
        </div>
        <button type="submit" class="btn btn-primary btn-small">Upload</button>
      </form>
    </div>
  </div>
<% } %>

<div class="card">
  <div class="map-container" id="map-container"></div>
  <% if (isDM) { %>
    <p class="form-hint" style="margin-top: 0.5rem;">Click anywhere on the map to add a location. Drag the gold party marker to move it.</p>
  <% } %>
</div>

<% if (isDM) { %>
<div id="map-add-modal" class="map-add-form" style="display:none;">
  <div class="card" style="max-width: 400px; margin: 0 auto;">
    <h3>Add Location</h3>
    <form action="/map/locations" method="POST">
      <input type="hidden" name="x" id="add-loc-x">
      <input type="hidden" name="y" id="add-loc-y">
      <div class="form-group">
        <label for="add-loc-name">Name</label>
        <input type="text" name="name" id="add-loc-name" required placeholder="Location name">
      </div>
      <div class="form-group">
        <label for="add-loc-desc">Description</label>
        <textarea name="description" id="add-loc-desc" rows="2" placeholder="Optional description"></textarea>
      </div>
      <div class="form-group">
        <label for="add-loc-icon">Icon</label>
        <select name="icon" id="add-loc-icon">
          <option value="pin">Pin</option>
          <option value="city">City</option>
          <option value="dungeon">Dungeon</option>
          <option value="tavern">Tavern</option>
        </select>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary btn-small">Add</button>
        <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('map-add-modal').style.display='none'">Cancel</button>
      </div>
    </form>
  </div>
</div>
<% } %>

<% if (locations.length > 0) { %>
<div class="card" style="margin-top: 1rem;">
  <h2>Locations</h2>
  <div class="admin-table-wrapper">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Type</th>
          <% if (isDM) { %><th>Actions</th><% } %>
        </tr>
      </thead>
      <tbody>
        <% for (const loc of locations) { %>
          <tr>
            <td><strong><%= loc.name %></strong></td>
            <td class="text-muted"><%= loc.description || 'â€”' %></td>
            <td><span class="map-marker-badge map-marker-<%= loc.icon %>"><%= loc.icon %></span></td>
            <% if (isDM) { %>
              <td>
                <form action="/map/locations/<%= loc.id %>/delete" method="POST" class="inline-form">
                  <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Delete this location?')">&times;</button>
                </form>
              </td>
            <% } %>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>
<% } %>

<script>
(function() {
  var locations = <%- JSON.stringify(locations) %>;
  var config = <%- JSON.stringify(config) %>;
  var isDM = <%= isDM ? 'true' : 'false' %>;
  var mapImagePath = config && config.image_path ? '/maps/' + config.image_path : null;

  var container = document.getElementById('map-container');
  var imgW = 1000, imgH = 700;

  var map = L.map('map-container', {
    crs: L.CRS.Simple,
    minZoom: -1,
    maxZoom: 3,
    zoomSnap: 0.25,
    attributionControl: false
  });

  var bounds = [[0, 0], [imgH, imgW]];

  if (mapImagePath) {
    L.imageOverlay(mapImagePath, bounds).addTo(map);
  } else {
    // Default parchment placeholder with SVG
    var svgPlaceholder = '<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="700" viewBox="0 0 1000 700">'
      + '<rect fill="#d4c5a9" width="1000" height="700"/>'
      + '<rect fill="#c4b594" x="20" y="20" width="960" height="660" rx="8"/>'
      + '<text x="500" y="320" font-family="serif" font-size="48" fill="#8b7355" text-anchor="middle">Your World Awaits</text>'
      + '<text x="500" y="380" font-family="serif" font-size="20" fill="#a89878" text-anchor="middle">Upload a map image to get started</text>'
      + '<g transform="translate(480,440)" fill="none" stroke="#a89878" stroke-width="2">'
      + '<circle cx="20" cy="20" r="18"/>'
      + '<line x1="20" y1="2" x2="20" y2="10"/>'
      + '<line x1="20" y1="30" x2="20" y2="38"/>'
      + '<line x1="2" y1="20" x2="10" y2="20"/>'
      + '<line x1="30" y1="20" x2="38" y2="20"/>'
      + '<text x="20" y="8" font-size="8" text-anchor="middle" fill="#a89878">N</text>'
      + '</g>'
      + '</svg>';
    var svgUrl = 'data:image/svg+xml;base64,' + btoa(svgPlaceholder);
    L.imageOverlay(svgUrl, bounds).addTo(map);
  }

  map.fitBounds(bounds);

  var iconColors = { pin: '#c0392b', city: '#2980b9', dungeon: '#8e44ad', tavern: '#27ae60', party: '#d4a843' };

  function makeIcon(type) {
    var color = iconColors[type] || iconColors.pin;
    return L.divIcon({
      className: 'map-marker-icon',
      html: '<div class="map-marker-dot" style="background:' + color + ';"></div>',
      iconSize: [14, 14],
      iconAnchor: [7, 7]
    });
  }

  function pctToLatLng(x, y) {
    return [imgH * (1 - y / 100), imgW * x / 100];
  }

  function latLngToPct(latlng) {
    return { x: (latlng.lng / imgW) * 100, y: (1 - latlng.lat / imgH) * 100 };
  }

  // Add location markers
  locations.forEach(function(loc) {
    var ll = pctToLatLng(loc.x, loc.y);
    var marker = L.marker(ll, { icon: makeIcon(loc.icon) }).addTo(map);
    var popupContent = '<strong>' + loc.name + '</strong>';
    if (loc.description) popupContent += '<br>' + loc.description;
    if (isDM) {
      popupContent += '<br><form action="/map/locations/' + loc.id + '/delete" method="POST" style="margin-top:0.5rem;">'
        + '<button type="submit" class="btn btn-small btn-danger" onclick="return confirm(\'Delete?\')" style="font-size:0.75rem;padding:0.2rem 0.5rem;">Delete</button></form>';
    }
    marker.bindPopup(popupContent);
  });

  // Add party marker
  var partyX = config ? config.party_x : 50;
  var partyY = config ? config.party_y : 50;
  var partyLL = pctToLatLng(partyX, partyY);
  var partyIcon = L.divIcon({
    className: 'map-marker-icon',
    html: '<div class="map-party-marker"></div>',
    iconSize: [18, 18],
    iconAnchor: [9, 9]
  });
  var partyMarker = L.marker(partyLL, { icon: partyIcon, draggable: isDM }).addTo(map);
  partyMarker.bindPopup('<strong>Party Location</strong>');

  if (isDM) {
    partyMarker.on('dragend', function() {
      var pct = latLngToPct(partyMarker.getLatLng());
      fetch('/map/party', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ x: pct.x, y: pct.y })
      });
    });

    map.on('click', function(e) {
      var pct = latLngToPct(e.latlng);
      if (pct.x < 0 || pct.x > 100 || pct.y < 0 || pct.y > 100) return;
      document.getElementById('add-loc-x').value = pct.x.toFixed(2);
      document.getElementById('add-loc-y').value = pct.y.toFixed(2);
      document.getElementById('add-loc-name').value = '';
      document.getElementById('add-loc-desc').value = '';
      document.getElementById('map-add-modal').style.display = 'block';
    });
  }
})();
</script>

<%- include('partials/foot') %>
