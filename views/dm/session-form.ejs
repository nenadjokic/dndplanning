<%- include('../partials/head', { pageTitle: 'New Quest Session' }) %>

<div class="page-header">
  <h1>Summon the Party</h1>
  <a href="/" class="btn btn-outline">Back to Chamber</a>
</div>

<% if (unavailabilities.length > 0) { %>
  <div class="card unavail-info-card">
    <h2>Adventurer Unavailability</h2>
    <p class="form-hint">These adventurers have marked dates they cannot play:</p>
    <div class="unavail-list">
      <% for (const u of unavailabilities) { %>
        <div class="unavail-item">
          <strong><%= u.username %></strong>
          <span class="unavail-date"><%= formatDate(u.date + 'T00:00:00', { weekday: 'short', month: 'short', day: 'numeric', showTime: false }) %></span>
          <% if (u.reason) { %>
            <span class="unavail-reason">&mdash; <%= u.reason %></span>
          <% } %>
        </div>
      <% } %>
    </div>
  </div>
<% } %>

<div class="card">
  <form action="/sessions" method="POST" id="session-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="form-group">
      <label for="category">Category</label>
      <select id="category" name="category">
        <option value="dnd">D&D</option>
        <option value="rpg">RPG</option>
        <option value="gamenight">Game Night</option>
        <option value="casual">Casual</option>
      </select>
    </div>
    <div class="form-group">
      <label for="title">Quest Title</label>
      <input type="text" id="title" name="title" required placeholder="e.g. The Mines of Phandelver - Session 5">
    </div>
    <div class="form-group">
      <label for="description">Quest Description (optional)</label>
      <textarea id="description" name="description" rows="3" placeholder="Brief description of the session..."></textarea>
    </div>

    <% if (typeof mapLocations !== 'undefined' && mapLocations.length > 0) { %>
    <div class="form-group">
      <label for="location_id">Location (optional)</label>
      <select id="location_id" name="location_id">
        <option value="">-- No location --</option>
        <% for (const loc of mapLocations) { %>
          <option value="<%= loc.id %>"><%= loc.map_name ? loc.map_name + ' â€” ' : '' %><%= loc.name %></option>
        <% } %>
      </select>
    </div>
    <% } %>

    <div class="form-group">
      <label>Proposed Time Slots</label>
      <p class="form-hint">Add possible dates and times for the party to vote on.</p>
      <div id="slots-container">
        <div class="slot-row">
          <input type="date" name="slot_dates_date" required>
          <select name="slot_dates_time" class="time-select"></select>
          <input type="text" name="slot_labels" placeholder="Label (optional, e.g. Evening)">
          <button type="button" class="btn btn-small btn-danger remove-slot" title="Remove slot">&times;</button>
          <div class="slot-unavail-warning"></div>
        </div>
      </div>
      <button type="button" id="add-slot" class="btn btn-outline btn-small">+ Add Another Slot</button>
    </div>

    <button type="submit" class="btn btn-primary">Post to Tavern Board</button>
  </form>
</div>

<script>
  window.__unavailData = <%- JSON.stringify(unavailabilities.map(u => ({ date: u.date, username: u.username, reason: u.reason }))) %>;
  window.__timeFormat = '<%= (typeof user !== 'undefined' && user && user.time_format) ? user.time_format : '24h' %>';
</script>

<%- include('../partials/foot') %>
