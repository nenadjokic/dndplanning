<%- include('partials/head', { pageTitle: 'Settings' }) %>

<div class="page-header">
  <h1>Settings</h1>
  <a href="/" class="btn btn-outline">Back to Quest Board</a>
</div>

<div class="settings-section card">
  <h2>Theme</h2>
  <form action="/settings/theme" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="form-group">
      <div class="radio-group">
        <label><input type="radio" name="theme" value="dark" <%= (settingsUser.theme || 'dark') === 'dark' ? 'checked' : '' %>> Dark (Dungeon)</label>
        <label><input type="radio" name="theme" value="light" <%= settingsUser.theme === 'light' ? 'checked' : '' %>> Light (Parchment)</label>
        <label><input type="radio" name="theme" value="auto" <%= settingsUser.theme === 'auto' ? 'checked' : '' %>> Auto (Light 6AM&ndash;7PM)</label>
      </div>
    </div>
    <button type="submit" class="btn btn-primary btn-small">Save Theme</button>
  </form>
</div>

<div class="settings-section card">
  <h2>Time Format</h2>
  <form action="/settings/time-format" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="form-group">
      <div class="radio-group">
        <label><input type="radio" name="time_format" value="24h" <%= (user.time_format || '24h') === '24h' ? 'checked' : '' %>> 24-hour (14:30)</label>
        <label><input type="radio" name="time_format" value="12h" <%= user.time_format === '12h' ? 'checked' : '' %>> 12-hour (2:30 PM)</label>
      </div>
    </div>
    <button type="submit" class="btn btn-primary btn-small">Save Time Format</button>
  </form>
</div>

<div class="settings-section card">
  <h2>Change Password</h2>
  <form action="/settings/password" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="form-group">
      <label for="current_password">Current Password</label>
      <input type="password" id="current_password" name="current_password" required>
    </div>
    <div class="form-group">
      <label for="new_password">New Password</label>
      <input type="password" id="new_password" name="new_password" required minlength="4">
    </div>
    <div class="form-group">
      <label for="confirm_password">Confirm New Password</label>
      <input type="password" id="confirm_password" name="confirm_password" required minlength="4">
    </div>
    <button type="submit" class="btn btn-primary btn-small">Change Password</button>
  </form>
</div>

<div class="settings-section card">
  <h2>Unavailability Days</h2>
  <p class="form-hint">Mark dates when you cannot play. The DM will see these when creating sessions.</p>
  <form action="/settings/unavailability" method="POST" class="unavail-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="form-group">
      <label for="unavail_date">Date</label>
      <input type="date" id="unavail_date" name="date" required>
    </div>
    <div class="form-group">
      <label for="unavail_reason">Reason (optional)</label>
      <input type="text" id="unavail_reason" name="reason" placeholder="e.g. Vacation, Work trip">
    </div>
    <button type="submit" class="btn btn-primary btn-small">Add Unavailability</button>
  </form>

  <% if (unavailabilities.length > 0) { %>
    <div class="unavail-list">
      <% for (const u of unavailabilities) { %>
        <div class="unavail-item">
          <span class="unavail-date"><%= formatDate(u.date + 'T00:00:00', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', showTime: false }) %></span>
          <% if (u.reason) { %>
            <span class="unavail-reason">&mdash; <%= u.reason %></span>
          <% } %>
          <form action="/settings/unavailability/<%= u.id %>/delete" method="POST" class="inline-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button type="submit" class="btn btn-small btn-danger">&times;</button>
          </form>
        </div>
      <% } %>
    </div>
  <% } %>
</div>

<div class="settings-section card">
  <h2>Calendar Feed</h2>
  <p class="form-hint">Subscribe to your D&D sessions in your favorite calendar app. The feed includes confirmed sessions and your unavailability days.</p>
  <% if (calendarUrl) { %>
    <div class="form-group">
      <label>Your Personal Calendar Feed URL</label>
      <input type="text" value="<%= calendarUrl %>" readonly onclick="this.select()" class="calendar-url-input">
    </div>
  <% } %>
  <form action="/settings/generate-calendar-token" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <button type="submit" class="btn btn-outline btn-small"><%= calendarUrl ? 'Regenerate Token' : 'Generate Calendar URL' %></button>
  </form>

  <div class="form-group" style="margin-top: 1rem;">
    <label>Sessions-Only Feed (Public)</label>
    <input type="text" value="<%= publicCalendarUrl %>" readonly onclick="this.select()" class="calendar-url-input">
  </div>
  <p class="form-hint">This public feed includes only confirmed sessions (no personal unavailability). Share with anyone.</p>
</div>

<div class="settings-section card">
  <h2>Notification Preferences</h2>
  <p class="form-hint">Choose which notifications you receive.</p>
  <form action="/settings/notifications" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="form-group">
      <label><input type="checkbox" name="notif_session_confirmed" value="1" <%= notifPrefs.session_confirmed ? 'checked' : '' %>> Session Confirmed</label>
    </div>
    <div class="form-group">
      <label><input type="checkbox" name="notif_session_cancelled" value="1" <%= notifPrefs.session_cancelled ? 'checked' : '' %>> Session Cancelled</label>
    </div>
    <div class="form-group">
      <label><input type="checkbox" name="notif_mention" value="1" <%= notifPrefs.mention ? 'checked' : '' %>> @Mentions</label>
    </div>
    <button type="submit" class="btn btn-primary btn-small">Save Preferences</button>
  </form>
</div>

<% if (googleEnabled) { %>
<div class="settings-section card">
  <h2>Google Account</h2>
  <% if (settingsUser.google_id) { %>
    <p>Linked to: <strong><%= settingsUser.google_email %></strong></p>
    <form action="/settings/google/unlink" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button type="submit" class="btn btn-outline btn-small btn-danger">Unlink Google Account</button>
    </form>
  <% } else { %>
    <p class="form-hint">Link your Google account for one-click sign-in.</p>
    <a href="/settings/google/link" class="btn btn-outline btn-small">Link Google Account</a>
  <% } %>
</div>
<% } %>

<%- include('partials/foot') %>
