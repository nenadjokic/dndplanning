<%- include('partials/head', { pageTitle: 'Profile' }) %>

<div class="page-header">
  <h1>My Profile</h1>
  <a href="/" class="btn btn-outline">Back to Quest Board</a>
</div>

<div class="settings-section card">
  <h2>Avatar</h2>
  <div class="avatar-section">
    <div class="avatar-preview">
      <% if (profileUser.avatar) { %>
        <img src="/avatars/<%= profileUser.avatar %>" alt="Avatar" class="avatar-preview-img">
      <% } else { %>
        <div class="avatar-placeholder"><%= profileUser.username.charAt(0).toUpperCase() %></div>
      <% } %>
    </div>
    <form action="/profile/avatar" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="form-group">
        <label for="avatar">Upload new avatar (max 2MB, images only)</label>
        <input type="file" id="avatar" name="avatar" accept="image/*">
      </div>
      <button type="submit" class="btn btn-primary btn-small">Upload Avatar</button>
    </form>
  </div>
</div>

<div class="settings-section card">
  <h2>Profile Info</h2>
  <form action="/profile" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <input type="hidden" name="character_info" value="<%= profileUser.character_info || '' %>">
    <div class="form-group">
      <label for="birthday">Birthday</label>
      <input type="text" class="date-only" id="birthday-display" placeholder="Select your birthday..." readonly>
      <input type="hidden" id="birthday" name="birthday" value="<%= profileUser.birthday || '' %>">
    </div>
    <div class="form-group">
      <label for="about">About You</label>
      <textarea id="about" name="about" rows="4" placeholder="Tell the party about yourself... (Markdown supported)"><%= profileUser.about || '' %></textarea>
      <small class="form-hint">Supports Markdown: **bold**, *italic*, [links](url), lists, etc.</small>
    </div>
    <%
      let socials = {};
      try {
        socials = profileUser.socials ? JSON.parse(profileUser.socials) : {};
      } catch (e) {
        socials = {};
      }
    %>
    <h3 style="margin-top: 1.5rem; margin-bottom: 0.75rem; color: var(--gold);">Social Links (Optional)</h3>
    <div class="form-group">
      <label for="social_discord">Discord</label>
      <input type="text" id="social_discord" name="social_discord" value="<%= socials.discord || '' %>" placeholder="username#1234">
    </div>
    <div class="form-group">
      <label for="social_steam">Steam</label>
      <input type="url" id="social_steam" name="social_steam" value="<%= socials.steam || '' %>" placeholder="https://steamcommunity.com/id/...">
    </div>
    <div class="form-group">
      <label for="social_twitter">Twitter/X</label>
      <input type="text" id="social_twitter" name="social_twitter" value="<%= socials.twitter || '' %>" placeholder="@username">
    </div>
    <div class="form-group">
      <label for="social_twitch">Twitch</label>
      <input type="text" id="social_twitch" name="social_twitch" value="<%= socials.twitch || '' %>" placeholder="username">
    </div>
    <div class="form-group">
      <label for="social_youtube">YouTube</label>
      <input type="url" id="social_youtube" name="social_youtube" value="<%= socials.youtube || '' %>" placeholder="https://youtube.com/@...">
    </div>
    <button type="submit" class="btn btn-primary btn-small">Save Profile</button>
  </form>
</div>

<div class="settings-section card">
  <h2>My Characters</h2>
  <p class="text-muted" style="margin-bottom: 1rem;">Create and manage your characters. Quick add below - name and class are all you need to start!</p>

  <!-- Inline Character Creation (Phase 4.3) -->
  <div class="inline-char-form-wrapper">
    <form action="/profile/characters" method="POST" enctype="multipart/form-data" id="inline-char-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">

      <div class="inline-char-quick">
        <div class="form-group" style="flex: 2; margin-bottom: 0;">
          <label for="char-name">Character Name *</label>
          <input type="text" name="name" id="char-name" required placeholder="e.g. Thorin Oakenshield" autofocus>
        </div>
        <div class="form-group" style="flex: 1; margin-bottom: 0;">
          <label for="char-class">Class</label>
          <select name="class" id="char-class">
            <option value="">— Class —</option>
            <option value="Artificer">Artificer</option>
            <option value="Barbarian">Barbarian</option>
            <option value="Bard">Bard</option>
            <option value="Cleric">Cleric</option>
            <option value="Druid">Druid</option>
            <option value="Fighter">Fighter</option>
            <option value="Monk">Monk</option>
            <option value="Paladin">Paladin</option>
            <option value="Ranger">Ranger</option>
            <option value="Rogue">Rogue</option>
            <option value="Sorcerer">Sorcerer</option>
            <option value="Warlock">Warlock</option>
            <option value="Wizard">Wizard</option>
          </select>
        </div>
        <div class="form-group" style="flex: 1; margin-bottom: 0;">
          <label for="char-race">Race</label>
          <input type="text" name="race" id="char-race" placeholder="e.g. Dwarf" list="race-suggestions">
          <datalist id="race-suggestions">
            <option value="Dragonborn">
            <option value="Dwarf">
            <option value="Elf">
            <option value="Gnome">
            <option value="Half-Elf">
            <option value="Half-Orc">
            <option value="Halfling">
            <option value="Human">
            <option value="Tiefling">
          </datalist>
        </div>
        <button type="submit" class="btn btn-primary btn-small" style="align-self: flex-end; white-space: nowrap;">Add Character</button>
      </div>

      <!-- Optional Details (Collapsible) -->
      <details class="inline-char-details">
        <summary>+ More Details (optional)</summary>
        <div class="inline-char-details-content">
          <div class="form-group">
            <label for="char-desc">Description / Backstory</label>
            <textarea name="description" id="char-desc" rows="3" placeholder="Backstory, traits, goals... (Markdown supported)"></textarea>
            <small class="form-hint">Supports Markdown: **bold**, *italic*, [links](url), lists, etc.</small>
          </div>
          <div class="form-group">
            <label for="char-avatar">Character Avatar</label>
            <input type="file" name="avatar" id="char-avatar" accept="image/*">
            <small class="form-hint">Will be center-cropped to 256×256.</small>
          </div>
        </div>
      </details>
    </form>
  </div>

  <% if (characters.length > 0) { %>
    <div class="characters-grid">
      <% for (const char of characters) { %>
        <div class="character-card" style="cursor: pointer;" data-edit-char="<%= char.id %>">
          <div class="character-card-avatar">
            <% if (char.avatar) { %>
              <img src="/avatars/<%= char.avatar %>" alt="<%= char.name %>" class="character-card-img">
            <% } else { %>
              <div class="character-card-placeholder"><%= char.name.charAt(0).toUpperCase() %></div>
            <% } %>
          </div>
          <div class="character-card-name"><%= char.name %></div>
          <% if (char.class || char.race) { %>
            <div class="character-card-meta">
              <% if (char.race) { %><%= char.race %><% } %>
              <% if (char.race && char.class) { %> <% } %>
              <% if (char.class) { %><span data-class="<%= char.class %>"><%= char.class %></span><% } %>
            </div>
          <% } %>
          <div style="margin-top: 0.35rem;">
            <a href="/profile/characters/<%= char.id %>/sheet" class="btn btn-small btn-outline" onclick="event.stopPropagation();"><%= char.sheet_data ? 'View Sheet' : 'Create Sheet' %></a>
          </div>
          <div class="character-card-actions">
            <button type="button" class="btn btn-small btn-outline" data-edit-char="<%= char.id %>">Edit</button>
            <form action="/profile/characters/<%= char.id %>/delete" method="POST" class="inline-form" onclick="event.stopPropagation();">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="btn btn-small btn-danger" onclick="event.stopPropagation(); return confirm('Delete this character?')">&times;</button>
            </form>
          </div>
        </div>
      <% } %>
    </div>
  <% } else { %>
    <%- include('partials/empty-state', {
      icon: '⚔️',
      title: 'No Characters Yet',
      description: 'Create your first character to join the adventure!',
      cta: ''
    }) %>
  <% } %>
</div>

<% if (profileUser.character_info || profileUser.character_avatar) { %>
<div class="settings-section card">
  <h2>Legacy Character (from old profile)</h2>
  <p class="text-muted">This character data is from the old single-character system. You can migrate it by creating a new character above.</p>
  <% if (profileUser.character_avatar) { %>
    <img src="/avatars/<%= profileUser.character_avatar %>" alt="Character" class="character-avatar-preview" style="margin-bottom: 0.5rem;">
  <% } %>
  <% if (profileUser.character_info) { %>
    <p><%= profileUser.character_info %></p>
  <% } %>
</div>
<% } %>

<div id="edit-char-modal" class="map-add-form" style="display:none;">
  <div class="card" style="max-width: 400px; margin: 0 auto;">
    <h3>Edit Character</h3>
    <form id="edit-char-form" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="form-group">
        <label for="edit-char-name">Character Name</label>
        <input type="text" name="name" id="edit-char-name" required>
      </div>
      <div style="display: flex; gap: 0.75rem;">
        <div class="form-group" style="flex: 1;">
          <label for="edit-char-class">Class</label>
          <select name="class" id="edit-char-class">
            <option value="">— Select Class —</option>
            <option value="Artificer">Artificer</option>
            <option value="Barbarian">Barbarian</option>
            <option value="Bard">Bard</option>
            <option value="Cleric">Cleric</option>
            <option value="Druid">Druid</option>
            <option value="Fighter">Fighter</option>
            <option value="Monk">Monk</option>
            <option value="Paladin">Paladin</option>
            <option value="Ranger">Ranger</option>
            <option value="Rogue">Rogue</option>
            <option value="Sorcerer">Sorcerer</option>
            <option value="Warlock">Warlock</option>
            <option value="Wizard">Wizard</option>
          </select>
        </div>
        <div class="form-group" style="flex: 1;">
          <label for="edit-char-race">Race</label>
          <input type="text" name="race" id="edit-char-race" placeholder="e.g. Dwarf">
        </div>
      </div>
      <div class="form-group">
        <label for="edit-char-desc">Description / Backstory</label>
        <textarea name="description" id="edit-char-desc" rows="4"></textarea>
        <small class="form-hint">Supports Markdown.</small>
      </div>
      <div class="form-group">
        <label for="edit-char-avatar">Character Avatar</label>
        <div id="edit-char-avatar-preview" style="display:none; margin-bottom:0.5rem;">
          <img id="edit-char-avatar-img" src="" alt="" style="width:48px; height:48px; object-fit:cover; border-radius:8px; border:1px solid var(--border);">
          <label style="display:inline-flex; align-items:center; gap:0.25rem; margin-left:0.5rem; font-weight:normal; font-size:0.85rem; cursor:pointer;">
            <input type="checkbox" name="remove_avatar" value="1" id="edit-remove-avatar"> Remove
          </label>
        </div>
        <input type="file" name="avatar" id="edit-char-avatar" accept="image/*">
        <small class="form-hint">Upload new image to replace. Cropped to 256&times;256.</small>
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <button type="submit" class="btn btn-primary btn-small">Save</button>
        <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('edit-char-modal').style.display='none'">Cancel</button>
        <a href="#" id="edit-char-sheet-link" class="btn btn-outline btn-small" style="margin-left: auto;">Open Character Sheet</a>
      </div>
    </form>
  </div>
</div>

<script>
var charsData = <%- JSON.stringify(characters.map(function(c) { return { id: c.id, name: c.name, description: c.description || '', avatar: c.avatar, class: c.class || '', race: c.race || '', hasSheet: !!c.sheet_data }; })) %>;
var charsById = {};
charsData.forEach(function(c) { charsById[c.id] = c; });

document.addEventListener('click', function(e) {
  var btn = e.target.closest('[data-edit-char]');
  if (btn) {
    var id = parseInt(btn.getAttribute('data-edit-char'), 10);
    var c = charsById[id];
    if (!c) return;
    document.getElementById('edit-char-form').action = '/profile/characters/' + id + '/edit';
    document.getElementById('edit-char-name').value = c.name;
    document.getElementById('edit-char-class').value = c.class;
    document.getElementById('edit-char-race').value = c.race;
    document.getElementById('edit-char-desc').value = c.description;
    document.getElementById('edit-remove-avatar').checked = false;
    if (c.avatar) {
      document.getElementById('edit-char-avatar-preview').style.display = 'block';
      document.getElementById('edit-char-avatar-img').src = '/avatars/' + c.avatar;
    } else {
      document.getElementById('edit-char-avatar-preview').style.display = 'none';
    }
    document.getElementById('edit-char-sheet-link').href = '/profile/characters/' + id + '/sheet';
    document.getElementById('edit-char-modal').style.display = 'block';
  }
});

// Initialize birthday picker
window.__timeFormat = '<%= (typeof user !== 'undefined' && user && user.time_format) ? user.time_format : '24h' %>';
window.__weekStart = '<%= (typeof user !== 'undefined' && user && user.week_start) ? user.week_start : 'monday' %>';
</script>
<script src="/js/datetime-picker.js?v=<%= appVersion %>"></script>
<script>
// Handle birthday date picker
document.addEventListener('DOMContentLoaded', function() {
  const birthdayDisplay = document.getElementById('birthday-display');
  const birthdayHidden = document.getElementById('birthday');

  // Wait for picker to initialize, then set initial value
  setTimeout(function() {
    if (birthdayHidden.value && birthdayDisplay.dateTimePicker) {
      const date = new Date(birthdayHidden.value + 'T00:00:00');
      birthdayDisplay.dataset.date = birthdayHidden.value;
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
      birthdayDisplay.value = monthNames[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();
    }
  }, 100);

  // Update hidden field on birthday change
  birthdayDisplay.addEventListener('change', function() {
    birthdayHidden.value = this.dataset.date || '';
  });
});
</script>

<%- include('partials/foot') %>
