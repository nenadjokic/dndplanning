<%- include('../partials/head', { pageTitle: session.title }) %>

<div class="page-header">
  <h1><%= session.title %></h1>
  <a href="/" class="btn btn-outline">Back to Chamber</a>
</div>

<div class="card">
  <span class="session-category"><%= session.category === 'gamenight' ? 'Game Night' : session.category === 'rpg' ? 'RPG' : session.category === 'casual' ? 'Casual' : 'D&D' %></span>
  <div class="session-status-badge session-status-badge-lg"><%= session.status %></div>
  <% if (session.description) { %>
    <p class="session-desc"><%= session.description %></p>
  <% } %>
  <% if (typeof locationName !== 'undefined' && locationName) { %>
    <p class="session-meta" style="margin-bottom: 0.5rem;">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
      <a href="/map"><%= locationName %></a>
    </p>
  <% } %>

  <% if (session.status === 'confirmed' || session.status === 'completed') { %>
    <% const confirmedSlot = slots.find(s => s.id === session.confirmed_slot_id); %>
    <% if (confirmedSlot) { %>
      <div class="confirmed-banner">
        <h3><%= session.status === 'completed' ? 'Quest Completed!' : 'Quest Date Proclaimed!' %></h3>
        <p>
          <%= formatDate(confirmedSlot.date_time, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) %>
          <% if (confirmedSlot.label) { %> &mdash; <%= confirmedSlot.label %><% } %>
        </p>
      </div>
    <% } %>
  <% } %>

  <% if (Object.keys(preferenceMap).length > 0) { %>
    <div class="preference-display">
      <h3>DM / Admin Preferences</h3>
      <% for (const uid in preferenceMap) { %>
        <% const pref = preferenceMap[uid]; %>
        <% const prefSlot = slots.find(s => s.id === pref.slot_id); %>
        <% if (prefSlot) { %>
          <p class="preference-entry">
            <% if (typeof allUsersMap !== 'undefined' && allUsersMap[uid] && allUsersMap[uid].avatar) { %>
              <img src="/avatars/<%= allUsersMap[uid].avatar %>" alt="" class="avatar-tiny">
            <% } %>
            <strong><%= pref.username %></strong> prefers:
            <%= formatDate(prefSlot.date_time, { weekday: 'short', month: 'short', day: 'numeric' }) %>
            <% if (prefSlot.label) { %> &mdash; <%= prefSlot.label %><% } %>
          </p>
        <% } %>
      <% } %>
    </div>
  <% } %>

  <% if (session.status === 'open') { %>
    <div class="dm-actions">
      <h3>Your Availability</h3>
      <form action="/votes/<%= session.id %>" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div class="vote-slots">
          <% for (const slot of slots) { %>
            <div class="vote-slot-card">
              <div class="vote-slot-header">
                <div class="slot-date"><%= formatDate(slot.date_time, { weekday: 'long', month: 'long', day: 'numeric', showTime: false }) %></div>
                <div class="slot-time"><%= formatTime(slot.date_time) %></div>
                <% if (slot.label) { %><div class="slot-label"><%= slot.label %></div><% } %>
              </div>
              <div class="vote-options">
                <label class="vote-option vote-available">
                  <input type="radio" name="vote_<%= slot.id %>" value="available" <%= myVotes[slot.id] === 'available' ? 'checked' : '' %>>
                  <span class="vote-icon">&#10003;</span> Available
                </label>
                <label class="vote-option vote-maybe">
                  <input type="radio" name="vote_<%= slot.id %>" value="maybe" <%= myVotes[slot.id] === 'maybe' ? 'checked' : '' %>>
                  <span class="vote-icon">?</span> Maybe
                </label>
                <label class="vote-option vote-unavailable">
                  <input type="radio" name="vote_<%= slot.id %>" value="unavailable" <%= myVotes[slot.id] === 'unavailable' ? 'checked' : '' %>>
                  <span class="vote-icon">&#10007;</span> Unavailable
                </label>
              </div>
            </div>
          <% } %>
        </div>
        <button type="submit" class="btn btn-primary" onclick="return confirm('Submit your availability for this quest?')">Submit Availability</button>
      </form>
    </div>
  <% } %>

  <h2>Party Availability</h2>
  <% if (players.length === 0) { %>
    <p class="empty-state-text">No adventurers have joined the guild yet.</p>
  <% } else { %>
    <%- include('../partials/slot-grid', { slots, players, voteMap, slotSummary, preferenceMap, allUsersMap: typeof allUsersMap !== 'undefined' ? allUsersMap : {}, unavailabilityMap: typeof unavailabilityMap !== 'undefined' ? unavailabilityMap : undefined }) %>
  <% } %>

  <% if (session.status === 'open') { %>
    <div class="dm-actions">
      <h3>Your Preferred Date</h3>
      <form action="/sessions/<%= session.id %>/prefer" method="POST" class="confirm-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div class="form-group">
          <label for="prefer_slot_id">Choose your preferred slot:</label>
          <select name="slot_id" id="prefer_slot_id">
            <option value="">-- No preference --</option>
            <% for (const slot of slots) { %>
              <option value="<%= slot.id %>" <%= myPreference && myPreference.slot_id === slot.id ? 'selected' : '' %>>
                <%= formatDate(slot.date_time, { weekday: 'short', month: 'short', day: 'numeric' }) %>
                <% if (slot.label) { %> - <%= slot.label %><% } %>
              </option>
            <% } %>
          </select>
        </div>
        <button type="submit" class="btn btn-outline">Set Preference</button>
      </form>
    </div>

    <div class="dm-actions">
      <h3>Proclaim a Quest Date</h3>
      <form action="/sessions/<%= session.id %>/confirm" method="POST" class="confirm-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div class="form-group">
          <label for="slot_id">Choose the time slot:</label>
          <select name="slot_id" id="slot_id" required>
            <option value="">-- Select a slot --</option>
            <% for (const slot of slots) { %>
              <option value="<%= slot.id %>">
                <%= formatDate(slot.date_time, { weekday: 'short', month: 'short', day: 'numeric' }) %>
                <% if (slot.label) { %> - <%= slot.label %><% } %>
                (<%= slotSummary[slot.id].available %> available)
              </option>
            <% } %>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Proclaim This Date</button>
      </form>
      <form action="/sessions/<%= session.id %>/cancel" method="POST" class="inline-form" style="margin-top: 1rem;">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="btn btn-danger" onclick="return confirm('Cancel this quest?')">Cancel Quest</button>
      </form>
    </div>
  <% } else { %>
    <div class="dm-actions">
      <form action="/sessions/<%= session.id %>/reopen" method="POST" class="inline-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="btn btn-outline">Reopen Quest Board</button>
      </form>
      <% if (session.status === 'completed') { %>
        <% const completedSlot = slots.find(s => s.id === session.confirmed_slot_id); %>
        <% if (completedSlot) { %>
          <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.9rem;">
            Session date: <%= formatDate(completedSlot.date_time, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) %>
            <% if (completedSlot.label) { %> &mdash; <%= completedSlot.label %><% } %>
          </p>
        <% } %>
      <% } %>
    </div>
  <% } %>

  <% if (session.status === 'confirmed') { %>
    <div class="dm-actions">
      <h3>Session Recap</h3>
      <form action="/sessions/<%= session.id %>/summary" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <div class="form-group">
          <label for="summary">Write a recap of this session:</label>
          <textarea name="summary" id="summary" rows="5" placeholder="Describe what happened during this session..."><%= session.summary || '' %></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Save &amp; Complete Quest</button>
      </form>
    </div>
  <% } else if (session.status === 'completed') { %>
    <div class="dm-actions">
      <h3>Session Recap</h3>
      <div id="recap-display">
        <div class="recap-text recap-rendered"><%- renderMarkdown(session.summary) %></div>
        <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('recap-display').style.display='none';document.getElementById('recap-edit').style.display='block';">Edit Recap</button>
      </div>
      <div id="recap-edit" style="display:none;">
        <form action="/sessions/<%= session.id %>/summary" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <div class="form-group">
            <label for="summary">Edit session recap:</label>
            <textarea name="summary" id="summary" rows="5"><%= session.summary %></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Save Recap</button>
          <button type="button" class="btn btn-outline" onclick="document.getElementById('recap-edit').style.display='none';document.getElementById('recap-display').style.display='block';">Cancel</button>
        </form>
      </div>
    </div>
  <% } %>

  <% if (user && user.role === 'admin') { %>
    <div class="dm-actions">
      <form action="/sessions/<%= session.id %>/delete" method="POST" class="inline-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="btn btn-danger" onclick="return confirm('Permanently delete this quest and all associated data? This cannot be undone.')">Delete Quest</button>
      </form>
    </div>
  <% } %>
</div>

<%- include('../partials/comments', { session, sessionPosts, sessionReplyMap }) %>

<%- include('../partials/foot') %>
