<%- include('../partials/head', { pageTitle: session.title }) %>

<div class="page-header">
  <h1><%= session.title %></h1>
  <a href="/" class="btn btn-outline">Back to Quest Board</a>
</div>

<div class="card">
  <span class="session-category"><%= session.category === 'gamenight' ? 'Game Night' : session.category === 'rpg' ? 'RPG' : session.category === 'casual' ? 'Casual' : 'D&D' %></span>
  <div class="session-status-badge session-status-badge-lg"><%= session.status %></div>

  <!-- Share Button -->
  <button class="share-main-btn" id="share-btn-<%= session.id %>" onclick="toggleShareMenu('<%= session.id %>')" title="Share Session" aria-label="Share Session">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
  </button>

  <!-- Share Menu (hidden by default) -->
  <div class="share-menu" id="share-menu-<%= session.id %>" style="display: none;">
    <button class="share-menu-btn" onclick="shareSession('whatsapp', '<%= session.id %>', '<%= session.title.replace(/'/g, "\\'") %>'); toggleShareMenu('<%= session.id %>')" title="Share on WhatsApp">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
    </button>
    <button class="share-menu-btn" onclick="shareSession('viber', '<%= session.id %>', '<%= session.title.replace(/'/g, "\\'") %>'); toggleShareMenu('<%= session.id %>')" title="Share on Viber">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512" fill="currentColor"><path d="M444 49.9C431.3 38.2 379.9.9 265.3.4c0 0-135.1-8.1-200.9 52.3C27.8 89.3 14.9 143 13.5 209.5c-1.4 66.5-3.1 191.1 117 224.9h.1l-.1 51.6s-.8 20.9 13 25.1c16.6 5.2 26.4-10.7 42.3-27.8 8.7-9.4 20.7-23.2 29.8-33.7 82.2 6.9 145.3-8.9 152.5-11.2 16.6-5.4 110.5-17.4 125.7-142 15.8-128.6-7.6-209.8-49.8-246.5zM457.9 287c-12.9 104-89 110.6-103 115.1-6 1.9-61.5 15.7-131.2 11.2 0 0-52 62.7-68.2 79-5.3 5.3-11.1 4.8-11-5.7 0-6.9.4-85.7.4-85.7-.1 0-.1 0 0 0-101.8-28.2-95.8-134.3-94.7-189.8 1.1-55.5 11.6-101 42.6-131.6 55.7-50.5 170.4-43 170.4-43 96.9.4 143.3 29.6 154.1 39.4 35.7 30.6 53.9 103.8 40.6 211.1zm-139-80.8c.4 8.6-12.5 9.2-12.9.6-1.1-22-11.4-32.7-32.6-33.9-8.6-.5-7.8-13.4.7-12.9 27.9 1.5 43.4 17.5 44.8 46.2zm20.3 11.3c1-42.4-25.5-75.6-75.8-79.3-8.5-.6-7.6-13.5.9-12.9 58 4.2 88.9 44.1 87.8 92.5-.1 8.6-13.1 8.2-12.9-.3zm47 13.4c.1 8.6-12.9 8.7-12.9.1-.6-81.5-54.9-125.9-120.8-126.4-8.5-.1-8.5-12.9 0-12.9 73.7.5 133 51.4 133.7 139.2zM374.9 329v.2c-10.8 19-31 40-51.8 33.3l-.2-.3c-21.1-5.9-70.8-31.5-102.2-56.5-16.2-12.8-31-27.9-42.4-42.4-10.3-12.9-20.7-28.2-30.8-46.6-21.3-38.5-26-55.7-26-55.7-6.7-20.8 14.2-41 33.3-51.8h.2c9.2-4.8 18-3.2 23.9 3.9 0 0 12.4 14.8 17.7 22.1 5 6.8 11.7 17.7 15.2 23.8 6.1 10.9 2.3 22-3.7 26.6l-12 9.6c-6.1 4.9-5.3 14-5.3 14s17.8 67.3 84.3 84.3c0 0 9.1.8 14-5.3l9.6-12c4.6-6 15.7-9.8 26.6-3.7 14.7 8.3 33.4 21.2 45.8 32.9 7 5.7 8.6 14.4 3.8 23.6z"/></svg>
    </button>
    <button class="share-menu-btn" onclick="shareSession('telegram', '<%= session.id %>', '<%= session.title.replace(/'/g, "\\'") %>'); toggleShareMenu('<%= session.id %>')" title="Share on Telegram">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
    </button>
    <button class="share-menu-btn" onclick="shareSession('discord', '<%= session.id %>', '<%= session.title.replace(/'/g, "\\'") %>'); toggleShareMenu('<%= session.id %>')" title="Share on Discord">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
    </button>
    <button class="share-menu-btn" onclick="shareSession('email', '<%= session.id %>', '<%= session.title.replace(/'/g, "\\'") %>'); toggleShareMenu('<%= session.id %>')" title="Share via Email">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
    </button>
    <button class="share-menu-btn" onclick="shareSession('copy', '<%= session.id %>', '<%= session.title.replace(/'/g, "\\'") %>'); toggleShareMenu('<%= session.id %>')" title="Copy Link">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
    </button>
  </div>
  <% if (session.description) { %>
    <p class="session-desc"><%= session.description %></p>
  <% } %>
  <% if (typeof locationName !== 'undefined' && locationName) { %>
    <p class="session-meta" style="margin-bottom: 0.5rem;">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
      <a href="/map"><%= locationName %></a>
    </p>
  <% } %>

  <% if (session.status === 'confirmed' || session.status === 'completed') { %>
    <% const confirmedSlot = slots.find(s => s.id === session.confirmed_slot_id); %>
    <% if (confirmedSlot) { %>
      <div class="confirmed-banner">
        <h3><%= session.status === 'completed' ? 'Quest Completed!' : 'Quest Date Proclaimed!' %></h3>
        <p>
          <%= formatDate(confirmedSlot.date_time, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) %>
          <% if (confirmedSlot.label) { %> &mdash; <%= confirmedSlot.label %><% } %>
        </p>
      </div>
    <% } %>
  <% } %>

  <% if (session.status === 'completed' && session.summary) { %>
    <div class="recap-card">
      <h3>Session Recap</h3>
      <div class="recap-text recap-rendered"><%- renderMarkdown(session.summary) %></div>
    </div>
  <% } %>

  <% if (session.status === 'open') { %>
    <h2>Cast Your Availability</h2>
    <form action="/votes/<%= session.id %>" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="vote-slots">
        <% for (const slot of slots) { %>
          <div class="vote-slot-card">
            <div class="vote-slot-header">
              <div class="slot-date"><%= formatDate(slot.date_time, { weekday: 'long', month: 'long', day: 'numeric', showTime: false }) %></div>
              <div class="slot-time"><%= formatTime(slot.date_time) %></div>
              <% if (slot.label) { %><div class="slot-label"><%= slot.label %></div><% } %>
            </div>
            <div class="vote-options">
              <label class="vote-option vote-available">
                <input type="radio" name="vote_<%= slot.id %>" value="available" <%= myVotes[slot.id] === 'available' ? 'checked' : '' %>>
                <span class="vote-icon">&#10003;</span> Available
              </label>
              <label class="vote-option vote-maybe">
                <input type="radio" name="vote_<%= slot.id %>" value="maybe" <%= myVotes[slot.id] === 'maybe' ? 'checked' : '' %>>
                <span class="vote-icon">?</span> Maybe
              </label>
              <label class="vote-option vote-unavailable">
                <input type="radio" name="vote_<%= slot.id %>" value="unavailable" <%= myVotes[slot.id] === 'unavailable' ? 'checked' : '' %>>
                <span class="vote-icon">&#10007;</span> Unavailable
              </label>
            </div>
          </div>
        <% } %>
      </div>
      <button type="submit" class="btn btn-primary">Submit Availability</button>
    </form>
  <% } else { %>
    <h2>Your Votes</h2>
    <div class="vote-slots">
      <% for (const slot of slots) { %>
        <div class="vote-slot-card">
          <div class="vote-slot-header">
            <div class="slot-date"><%= formatDate(slot.date_time, { weekday: 'long', month: 'long', day: 'numeric', showTime: false }) %></div>
            <div class="slot-time"><%= formatTime(slot.date_time) %></div>
            <% if (slot.label) { %><div class="slot-label"><%= slot.label %></div><% } %>
          </div>
          <div class="vote-result vote-<%= myVotes[slot.id] || 'none' %>">
            <% if (myVotes[slot.id] === 'available') { %>
              &#10003; Available
            <% } else if (myVotes[slot.id] === 'maybe') { %>
              ? Maybe
            <% } else if (myVotes[slot.id] === 'unavailable') { %>
              &#10007; Unavailable
            <% } else { %>
              &mdash; No vote
            <% } %>
          </div>
        </div>
      <% } %>
    </div>
  <% } %>
</div>

<% if (typeof players !== 'undefined' && players.length > 0) { %>
<div class="card">
  <h2>Party Availability</h2>
  <%- include('../partials/slot-grid', { slots, players, voteMap, slotSummary, preferenceMap: {}, allUsersMap: typeof allUsersMap !== 'undefined' ? allUsersMap : {}, unavailabilityMap: typeof unavailabilityMap !== 'undefined' ? unavailabilityMap : {} }) %>
</div>
<% } %>

<%- include('../partials/comments', { session, sessionPosts, sessionReplyMap }) %>

<%- include('../partials/foot') %>
