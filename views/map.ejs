<%- include('partials/head', { pageTitle: map.name }) %>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="page-header">
  <h1><%= map.name %></h1>
  <div>
    <button type="button" class="btn btn-outline btn-small" id="map-fullscreen-btn" title="Fullscreen">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
      Fullscreen
    </button>
    <% if (isDM) { %>
      <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('upload-form').style.display = document.getElementById('upload-form').style.display === 'none' ? 'block' : 'none'">Upload Map</button>
    <% } %>
    <a href="/map" class="btn btn-outline btn-small">All Maps</a>
  </div>
</div>

<% if (isDM) { %>
  <div id="upload-form" style="display:none; margin-bottom: 1rem;">
    <div class="card">
      <form action="/map/<%= map.id %>/upload" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="map_image">Map Image (JPG, PNG, GIF, WebP &mdash; max 5MB)</label>
          <input type="file" name="map_image" id="map_image" accept="image/*">
        </div>
        <button type="submit" class="btn btn-primary btn-small">Upload</button>
      </form>
    </div>
  </div>
<% } %>

<div class="card map-wrapper" id="map-wrapper">
  <button type="button" class="map-fullscreen-close" id="map-fullscreen-close" title="Exit fullscreen">&times;</button>
  <div class="map-container" id="map-container"></div>
  <% if (isDM) { %>
    <p class="form-hint map-hint" style="margin-top: 0.5rem;">Click anywhere on the map to add a location. Drag the gold party marker to move it.</p>
  <% } %>
</div>

<% if (isDM) { %>
<div id="map-add-modal" class="map-add-form" style="display:none;">
  <div class="card" style="max-width: 400px; margin: 0 auto;">
    <h3>Add Location</h3>
    <form action="/map/<%= map.id %>/locations" method="POST">
      <input type="hidden" name="x" id="add-loc-x">
      <input type="hidden" name="y" id="add-loc-y">
      <div class="form-group">
        <label for="add-loc-name">Name</label>
        <input type="text" name="name" id="add-loc-name" required placeholder="Location name">
      </div>
      <div class="form-group">
        <label for="add-loc-desc">Description</label>
        <textarea name="description" id="add-loc-desc" rows="2" placeholder="Optional description"></textarea>
      </div>
      <div class="form-group">
        <label for="add-loc-icon">Icon</label>
        <select name="icon" id="add-loc-icon">
          <option value="pin">Pin</option>
          <option value="city">City</option>
          <option value="dungeon">Dungeon</option>
          <option value="tavern">Tavern</option>
        </select>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary btn-small">Add</button>
        <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('map-add-modal').style.display='none'">Cancel</button>
      </div>
    </form>
  </div>
</div>
<% } %>

<% if (locations.length > 0) { %>
<div class="card" style="margin-top: 1rem;">
  <h2>Locations</h2>
  <div class="admin-table-wrapper">
    <table class="admin-table">
      <thead>
        <tr>
          <th style="width:2rem;"></th>
          <th>Name</th>
          <th>Description</th>
          <th>Type</th>
          <% if (isDM) { %><th>Actions</th><% } %>
        </tr>
      </thead>
      <tbody>
        <% for (const loc of locations) { %>
          <tr>
            <td>
              <button type="button" class="btn-map-pin" data-center-loc="<%= loc.id %>" title="Center map on this location">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
              </button>
            </td>
            <td><strong><%= loc.name %></strong></td>
            <td class="text-muted"><%= loc.description || 'â€”' %></td>
            <td><span class="map-marker-badge map-marker-<%= loc.icon %>"><%= loc.icon %></span></td>
            <% if (isDM) { %>
              <td>
                <div style="display: flex; gap: 0.25rem;">
                  <button type="button" class="btn btn-small btn-outline" data-table-edit-loc="<%= loc.id %>">Edit</button>
                  <form action="/map/<%= map.id %>/locations/<%= loc.id %>/delete" method="POST" class="inline-form">
                    <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Delete this location?')">&times;</button>
                  </form>
                </div>
              </td>
            <% } %>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>
<% } %>

<% if (isDM) { %>
<div id="map-edit-modal" class="map-add-form" style="display:none;">
  <div class="card" style="max-width: 400px; margin: 0 auto;">
    <h3>Edit Location</h3>
    <form id="edit-loc-form" method="POST">
      <div class="form-group">
        <label for="edit-loc-name">Name</label>
        <input type="text" name="name" id="edit-loc-name" required>
      </div>
      <div class="form-group">
        <label for="edit-loc-desc">Description</label>
        <textarea name="description" id="edit-loc-desc" rows="2"></textarea>
      </div>
      <div class="form-group">
        <label for="edit-loc-icon">Icon</label>
        <select name="icon" id="edit-loc-icon">
          <option value="pin">Pin</option>
          <option value="city">City</option>
          <option value="dungeon">Dungeon</option>
          <option value="tavern">Tavern</option>
        </select>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary btn-small">Save</button>
        <button type="button" class="btn btn-outline btn-small" onclick="document.getElementById('map-edit-modal').style.display='none'">Cancel</button>
      </div>
    </form>
  </div>
</div>
<% } %>

<script>
(function() {
  var locations = <%- JSON.stringify(locations) %>;
  var mapData = <%- JSON.stringify(map) %>;
  var isDM = <%= isDM ? 'true' : 'false' %>;
  var mapImagePath = mapData.image_path ? '/maps/' + mapData.image_path : null;

  var imgW = 1000, imgH = 700;

  var leafletMap = L.map('map-container', {
    crs: L.CRS.Simple,
    minZoom: -1,
    maxZoom: 3,
    zoomSnap: 0.25,
    attributionControl: false
  });

  var bounds = [[0, 0], [imgH, imgW]];

  if (mapImagePath) {
    L.imageOverlay(mapImagePath, bounds).addTo(leafletMap);
  } else {
    var svgPlaceholder = '<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="700" viewBox="0 0 1000 700">'
      + '<rect fill="#d4c5a9" width="1000" height="700"/>'
      + '<rect fill="#c4b594" x="20" y="20" width="960" height="660" rx="8"/>'
      + '<text x="500" y="320" font-family="serif" font-size="48" fill="#8b7355" text-anchor="middle">Your World Awaits</text>'
      + '<text x="500" y="380" font-family="serif" font-size="20" fill="#a89878" text-anchor="middle">Upload a map image to get started</text>'
      + '<g transform="translate(480,440)" fill="none" stroke="#a89878" stroke-width="2">'
      + '<circle cx="20" cy="20" r="18"/>'
      + '<line x1="20" y1="2" x2="20" y2="10"/>'
      + '<line x1="20" y1="30" x2="20" y2="38"/>'
      + '<line x1="2" y1="20" x2="10" y2="20"/>'
      + '<line x1="30" y1="20" x2="38" y2="20"/>'
      + '<text x="20" y="8" font-size="8" text-anchor="middle" fill="#a89878">N</text>'
      + '</g>'
      + '</svg>';
    var svgUrl = 'data:image/svg+xml;base64,' + btoa(svgPlaceholder);
    L.imageOverlay(svgUrl, bounds).addTo(leafletMap);
  }

  leafletMap.fitBounds(bounds);

  var iconColors = { pin: '#c0392b', city: '#2980b9', dungeon: '#8e44ad', tavern: '#27ae60', party: '#d4a843' };

  function makeIcon(type) {
    var color = iconColors[type] || iconColors.pin;
    return L.divIcon({
      className: 'map-marker-icon',
      html: '<div class="map-marker-dot" style="background:' + color + ';"></div>',
      iconSize: [14, 14],
      iconAnchor: [7, 7]
    });
  }

  function pctToLatLng(x, y) {
    return [imgH * (1 - y / 100), imgW * x / 100];
  }

  function latLngToPct(latlng) {
    return { x: (latlng.lng / imgW) * 100, y: (1 - latlng.lat / imgH) * 100 };
  }

  function escHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  var locById = {};
  locations.forEach(function(loc) { locById[loc.id] = loc; });

  locations.forEach(function(loc) {
    var ll = pctToLatLng(loc.x, loc.y);
    var marker = L.marker(ll, { icon: makeIcon(loc.icon) }).addTo(leafletMap);
    var popupContent = '<strong>' + escHtml(loc.name) + '</strong>';
    if (loc.description) popupContent += '<br>' + escHtml(loc.description);
    if (isDM) {
      popupContent += '<div style="margin-top:0.5rem; display:flex; gap:0.25rem;">'
        + '<button type="button" class="btn btn-small btn-outline" data-edit-loc="' + loc.id + '" style="font-size:0.75rem;padding:0.2rem 0.5rem;">Edit</button>'
        + '<form action="/map/<%= map.id %>/locations/' + loc.id + '/delete" method="POST">'
        + '<button type="submit" class="btn btn-small btn-danger" onclick="return confirm(\'Delete this location?\')" style="font-size:0.75rem;padding:0.2rem 0.5rem;">Delete</button></form>'
        + '</div>';
    }
    var popup = L.popup().setContent(popupContent);
    marker.bindPopup(popup);
    marker.on('popupopen', function() {
      var editBtn = document.querySelector('[data-edit-loc="' + loc.id + '"]');
      if (editBtn) {
        editBtn.addEventListener('click', function() {
          var l = locById[loc.id];
          openEditLocation(l.id, l.name, l.description || '', l.icon);
        });
      }
    });
  });

  var partyX = mapData.party_x || 50;
  var partyY = mapData.party_y || 50;
  var partyLL = pctToLatLng(partyX, partyY);
  var partyIcon = L.divIcon({
    className: 'map-marker-icon',
    html: '<div class="map-party-marker"></div>',
    iconSize: [18, 18],
    iconAnchor: [9, 9]
  });
  var partyMarker = L.marker(partyLL, { icon: partyIcon, draggable: isDM }).addTo(leafletMap);
  partyMarker.bindPopup('<strong>Party Location</strong>');

  if (isDM) {
    partyMarker.on('dragend', function() {
      var pct = latLngToPct(partyMarker.getLatLng());
      fetch('/map/<%= map.id %>/party', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ x: pct.x, y: pct.y })
      });
    });

    leafletMap.on('click', function(e) {
      var pct = latLngToPct(e.latlng);
      if (pct.x < 0 || pct.x > 100 || pct.y < 0 || pct.y > 100) return;
      document.getElementById('add-loc-x').value = pct.x.toFixed(2);
      document.getElementById('add-loc-y').value = pct.y.toFixed(2);
      document.getElementById('add-loc-name').value = '';
      document.getElementById('add-loc-desc').value = '';
      document.getElementById('map-add-modal').style.display = 'block';
    });
  }

  var wrapper = document.getElementById('map-wrapper');
  var fsBtn = document.getElementById('map-fullscreen-btn');
  var fsCloseBtn = document.getElementById('map-fullscreen-close');
  var isFullscreen = false;

  function toggleFullscreen() {
    isFullscreen = !isFullscreen;
    if (isFullscreen) {
      wrapper.classList.add('map-fullscreen');
      fsBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg> Exit Fullscreen';
    } else {
      wrapper.classList.remove('map-fullscreen');
      fsBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg> Fullscreen';
    }
    setTimeout(function() { leafletMap.invalidateSize(); }, 100);
  }

  fsBtn.addEventListener('click', toggleFullscreen);
  fsCloseBtn.addEventListener('click', function() {
    if (isFullscreen) toggleFullscreen();
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isFullscreen) {
      toggleFullscreen();
    }
  });

  document.addEventListener('click', function(e) {
    var btn = e.target.closest('[data-table-edit-loc]');
    if (btn) {
      var id = parseInt(btn.getAttribute('data-table-edit-loc'), 10);
      var l = locById[id];
      if (l) openEditLocation(l.id, l.name, l.description || '', l.icon);
    }

    var pinBtn = e.target.closest('[data-center-loc]');
    if (pinBtn) {
      var locId = parseInt(pinBtn.getAttribute('data-center-loc'), 10);
      var loc = locById[locId];
      if (loc) {
        var ll = pctToLatLng(loc.x, loc.y);
        leafletMap.setView(ll, 1, { animate: true });
        document.getElementById('map-wrapper').scrollIntoView({ behavior: 'smooth' });
      }
    }
  });
})();

<% if (isDM) { %>
function openEditLocation(id, name, desc, icon) {
  document.getElementById('edit-loc-form').action = '/map/<%= map.id %>/locations/' + id + '/edit';
  document.getElementById('edit-loc-name').value = name;
  document.getElementById('edit-loc-desc').value = desc;
  document.getElementById('edit-loc-icon').value = icon;
  document.getElementById('map-edit-modal').style.display = 'block';
}
<% } %>
</script>

<%- include('partials/foot') %>
