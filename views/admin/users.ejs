<%- include('../partials/head', { pageTitle: 'Guild Settings' }) %>

<div class="page-header">
  <h1>Guild Settings</h1>
  <a href="/" class="btn btn-outline">Back to Chamber</a>
</div>

<div class="card">
  <h2>Guild Members</h2>
  <div class="admin-table-wrapper">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Role</th>
          <th>Joined</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% for (const u of users) { %>
          <tr>
            <td><%= u.username %></td>
            <td>
              <span class="role-badge role-<%= u.role %>">
                <%= u.role === 'admin' ? 'Guild Master' : u.role === 'dm' ? 'Dungeon Master' : 'Adventurer' %>
              </span>
            </td>
            <td class="admin-date"><%= formatDate(u.created_at, { month: 'short', day: 'numeric', year: 'numeric', showTime: false }) %></td>
            <td>
              <% if (u.role === 'admin') { %>
                <span class="text-muted">&mdash;</span>
              <% } else { %>
                <form action="/admin/users/<%= u.id %>/role" method="POST" class="role-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <select name="role" class="role-select">
                    <option value="player" <%= u.role === 'player' ? 'selected' : '' %>>Adventurer</option>
                    <option value="dm" <%= u.role === 'dm' ? 'selected' : '' %>>Dungeon Master</option>
                  </select>
                  <button type="submit" class="btn btn-small btn-primary">Save</button>
                </form>
                <form action="/admin/users/<%= u.id %>/reset-password" method="POST" class="inline-form" style="margin-left: 0.5rem;">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <button type="submit" class="btn btn-small btn-outline" onclick="return confirm('Reset password for <%= u.username %>?')" title="Reset Password">&#x1F511;</button>
                </form>
                <form action="/admin/users/<%= u.id %>/delete" method="POST" class="inline-form" style="margin-left: 0.5rem;">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Delete this user and ALL their data? This cannot be undone.')">&times;</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<div class="card" style="margin-top: 1.5rem;">
  <h2>Realm Updates</h2>
  <p>Current version: <strong>v<%= appVersion %></strong></p>
  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
    <button type="button" class="btn btn-outline btn-small" onclick="checkForUpdate()">Check for Updates</button>
    <button type="button" class="btn btn-primary btn-small" onclick="performAppUpdate()" id="app-update-btn" style="display: none;">
      üöÄ Update Now
    </button>
  </div>
  <div id="update-result" style="margin-top: 1rem;"></div>
  <div id="app-update-progress" style="margin-top: 1rem; display: none;">
    <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem;">
      <div style="height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
        <div id="app-progress-bar" style="height: 100%; background: var(--primary); width: 0%; transition: width 0.3s;"></div>
      </div>
      <div id="app-progress-text" style="font-size: 0.85rem; color: var(--text-secondary); max-height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;"></div>
    </div>
  </div>
</div>

<div class="card" style="margin-top: 1.5rem;">
  <h2>üìö Ancient Lore Library</h2>
  <p class="text-muted" style="margin-bottom: 1rem;">D&D 5e data from <a href="https://5e.tools" target="_blank">5e.tools</a> ‚Äî spells, classes, races, and items.</p>
  <div id="dnd-data-status" style="margin-bottom: 1rem;">
    <p style="font-size: 0.9rem; color: var(--text-secondary);">Loading...</p>
  </div>
  <button type="button" class="btn btn-primary btn-small" onclick="updateDndData()" id="update-dnd-btn">
    üîÑ Update Library
  </button>
  <div id="dnd-data-progress" style="margin-top: 1rem; display: none;">
    <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem;">
      <div style="height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
        <div id="dnd-progress-bar" style="height: 100%; background: var(--primary); width: 0%; transition: width 0.3s;"></div>
      </div>
      <div id="dnd-progress-text" style="font-size: 0.85rem; color: var(--text-secondary); max-height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;"></div>
    </div>
  </div>
</div>

<div class="card comms-section" style="margin-top: 1.5rem;">
  <h2>Google Login</h2>
  <p class="text-muted" style="margin-bottom: 1rem;">Allow guild members to sign in with their Google account.</p>

  <div class="discord-setup-guide" style="margin-bottom: 1rem; padding: 1rem; background: rgba(66, 133, 244, 0.08); border: 1px solid rgba(66, 133, 244, 0.3); border-radius: var(--radius);">
    <h3 style="color: #4285F4; margin-bottom: 0.5rem; font-size: 1rem;">Google OAuth Setup Guide</h3>
    <ol style="margin: 0; padding-left: 1.25rem; font-size: 0.88rem; color: var(--text-secondary); line-height: 1.7;">
      <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener noreferrer">console.cloud.google.com/apis/credentials</a></li>
      <li>Create a new project (or select an existing one)</li>
      <li>Click <strong>"+ CREATE CREDENTIALS"</strong> &rarr; <strong>"OAuth client ID"</strong></li>
      <li>If prompted, configure the <strong>OAuth consent screen</strong> first:
        <ul style="margin: 0.25rem 0; padding-left: 1rem;">
          <li>User Type: <strong>External</strong></li>
          <li>App name: <strong>Quest Planner</strong></li>
          <li>User support email: your email</li>
          <li>Authorized domains: your domain (e.g. <code>example.com</code>)</li>
          <li>Scopes: add <strong>email</strong> and <strong>profile</strong></li>
        </ul>
      </li>
      <li>Back in Credentials, create an <strong>OAuth client ID</strong>:
        <ul style="margin: 0.25rem 0; padding-left: 1rem;">
          <li>Application type: <strong>Web application</strong></li>
          <li>Authorized redirect URIs: add <code><span id="google-redirect-uri-hint"></span></code></li>
        </ul>
      </li>
      <li>Copy the <strong>Client ID</strong> and <strong>Client Secret</strong> and paste them below</li>
    </ol>
  </div>

  <form action="/admin/google-oauth" method="POST" id="google-oauth-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="form-group">
      <label><input type="checkbox" name="google_enabled" value="1" id="google_enabled"> Enable Google Login</label>
    </div>
    <div class="form-group">
      <label for="google_client_id">Client ID</label>
      <input type="text" name="google_client_id" id="google_client_id" class="form-input" placeholder="e.g. 123456789-abc.apps.googleusercontent.com">
    </div>
    <div class="form-group">
      <label for="google_client_secret">Client Secret</label>
      <input type="text" name="google_client_secret" id="google_client_secret" class="form-input" placeholder="e.g. GOCSPX-...">
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
  </form>
</div>

<div class="card comms-section" style="margin-top: 1.5rem;">
  <h2>Communications Center</h2>
  <p class="text-muted" style="margin-bottom: 1rem;">Configure a messaging provider to broadcast session events to your guild.</p>

  <form action="/admin/notifications" method="POST" id="comms-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="form-group">
      <label for="comms-provider">Provider</label>
      <select name="active_provider" id="comms-provider" class="role-select" style="width: 100%; padding: 0.5rem;" onchange="toggleProviderFields()">
        <option value="none">None</option>
        <option value="discord">Discord</option>
        <option value="telegram">Telegram</option>
        <option value="viber">Viber</option>
      </select>
    </div>

    <div class="provider-fieldset" id="fields-discord">
      <div class="discord-setup-guide" style="margin-bottom: 1rem; padding: 1rem; background: rgba(88, 101, 242, 0.08); border: 1px solid rgba(88, 101, 242, 0.3); border-radius: var(--radius);">
        <h3 style="color: #5865F2; margin-bottom: 0.5rem; font-size: 1rem;">Discord Bot Setup Guide</h3>
        <ol style="margin: 0; padding-left: 1.25rem; font-size: 0.88rem; color: var(--text-secondary); line-height: 1.7;">
          <li>Go to <a href="https://discord.com/developers/applications" target="_blank" rel="noopener noreferrer">discord.com/developers/applications</a></li>
          <li>Click <strong>"New Application"</strong> &rarr; give it a name (e.g. "Quest Planner") &rarr; Create</li>
          <li>In the left sidebar, click <strong>"Bot"</strong></li>
          <li>Click <strong>"Reset Token"</strong> &rarr; confirm &rarr; <strong>copy the token</strong> and paste it below</li>
          <li>In the left sidebar, click <strong>"OAuth2"</strong></li>
          <li>Scroll down to <strong>"OAuth2 URL Generator"</strong></li>
          <li>Under <em>Scopes</em>, check <strong>"bot"</strong></li>
          <li>Under <em>Bot Permissions</em>, check: <strong>"Send Messages"</strong> and <strong>"Embed Links"</strong></li>
          <li><strong>Copy the generated URL</strong> at the bottom and open it in your browser</li>
          <li>Select your Discord server and click <strong>"Authorize"</strong></li>
          <li>The bot is now in your server! Copy the channel ID below</li>
        </ol>
      </div>
      <div class="form-group">
        <label for="discord_bot_token">Bot Token</label>
        <input type="text" name="discord_bot_token" id="discord_bot_token" class="form-input" placeholder="Paste bot token from Step 4">
        <small class="form-hint">From the Bot page &rarr; Reset Token &rarr; Copy</small>
      </div>
      <div class="form-group">
        <label for="discord_channel_id">Channel ID</label>
        <input type="text" name="discord_channel_id" id="discord_channel_id" class="form-input" placeholder="e.g. 1234567890123456789">
        <small class="form-hint">In Discord: Settings &rarr; Advanced &rarr; enable <strong>Developer Mode</strong>. Then right-click the channel &rarr; <strong>Copy Channel ID</strong>.</small>
      </div>
    </div>

    <div class="provider-fieldset" id="fields-telegram">
      <div class="form-group">
        <label for="telegram_bot_token">Bot Token</label>
        <input type="text" name="telegram_bot_token" id="telegram_bot_token" class="form-input" placeholder="Telegram bot token">
        <small class="form-hint">Message @BotFather on Telegram &rarr; /newbot &rarr; copy the token</small>
      </div>
      <div class="form-group">
        <label for="telegram_chat_id">Chat ID</label>
        <input type="text" name="telegram_chat_id" id="telegram_chat_id" class="form-input" placeholder="Telegram chat or group ID">
        <small class="form-hint">Add bot to your group, send a message, then visit api.telegram.org/bot{TOKEN}/getUpdates to find the chat_id</small>
      </div>
    </div>

    <div class="provider-fieldset" id="fields-viber">
      <div class="form-group">
        <label for="viber_auth_token">Auth Token</label>
        <input type="text" name="viber_auth_token" id="viber_auth_token" class="form-input" placeholder="Viber auth token">
        <small class="form-hint">Create a bot at partners.viber.com &rarr; copy the Auth Token</small>
      </div>
      <div class="form-group">
        <label for="viber_admin_id">Admin / Subscriber ID</label>
        <input type="text" name="viber_admin_id" id="viber_admin_id" class="form-input" placeholder="Viber receiver ID">
        <small class="form-hint">Your Viber user ID (subscribe to your bot, then check the Viber API for your ID)</small>
      </div>
    </div>

    <div class="provider-fieldset" id="fields-public-url" style="display: none;">
      <div class="form-group">
        <label for="public_url">Public URL</label>
        <input type="text" name="public_url" id="public_url" class="form-input" placeholder="https://quest.example.com">
        <small class="form-hint">Your app's public address (e.g. https://quest.example.com). Used for message links and Viber webhook.</small>
      </div>
    </div>

    <div class="comms-actions">
      <button type="submit" class="btn btn-primary">Save</button>
      <button type="button" class="btn btn-outline" onclick="testConnection()">Test Connection</button>
    </div>
  </form>

  <div id="comms-test-result" class="comms-test-result"></div>
</div>

<script>
function toggleProviderFields() {
  var provider = document.getElementById('comms-provider').value;
  document.querySelectorAll('.provider-fieldset').forEach(function(el) {
    el.classList.remove('active');
  });
  if (provider !== 'none') {
    var fields = document.getElementById('fields-' + provider);
    if (fields) fields.classList.add('active');
    document.getElementById('fields-public-url').classList.add('active');
  }
}

function loadCommsConfig() {
  fetch('/admin/notifications/config')
    .then(function(r) { return r.json(); })
    .then(function(cfg) {
      if (cfg.active_provider) {
        document.getElementById('comms-provider').value = cfg.active_provider;
      }
      if (cfg.discord_bot_token) document.getElementById('discord_bot_token').value = cfg.discord_bot_token;
      if (cfg.discord_channel_id) document.getElementById('discord_channel_id').value = cfg.discord_channel_id;
      if (cfg.telegram_bot_token) document.getElementById('telegram_bot_token').value = cfg.telegram_bot_token;
      if (cfg.telegram_chat_id) document.getElementById('telegram_chat_id').value = cfg.telegram_chat_id;
      if (cfg.viber_auth_token) document.getElementById('viber_auth_token').value = cfg.viber_auth_token;
      if (cfg.viber_admin_id) document.getElementById('viber_admin_id').value = cfg.viber_admin_id;
      if (cfg.public_url) document.getElementById('public_url').value = cfg.public_url;
      toggleProviderFields();
    })
    .catch(function() {});
}

function testConnection() {
  var resultDiv = document.getElementById('comms-test-result');
  resultDiv.textContent = 'Testing...';
  resultDiv.className = 'comms-test-result';

  fetch('/admin/notifications/test', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        resultDiv.textContent = 'Connection successful! Test message sent.';
        resultDiv.className = 'comms-test-result comms-test-success';
      } else {
        resultDiv.textContent = 'Connection failed: ' + (data.error || 'Unknown error');
        resultDiv.className = 'comms-test-result comms-test-error';
      }
    })
    .catch(function() {
      resultDiv.textContent = 'Connection test failed.';
      resultDiv.className = 'comms-test-result comms-test-error';
    });
}

function loadGoogleOAuthConfig() {
  // Show redirect URI hint
  var hint = document.getElementById('google-redirect-uri-hint');
  if (hint) hint.textContent = window.location.origin + '/auth/google/callback';

  fetch('/admin/google-oauth/config')
    .then(function(r) { return r.json(); })
    .then(function(cfg) {
      if (cfg.enabled) document.getElementById('google_enabled').checked = true;
      if (cfg.client_id) document.getElementById('google_client_id').value = cfg.client_id;
      if (cfg.client_secret) document.getElementById('google_client_secret').value = cfg.client_secret;
    })
    .catch(function() {});
}

function checkForUpdate() {
  var resultDiv = document.getElementById('update-result');
  var updateBtn = document.getElementById('app-update-btn');

  resultDiv.textContent = 'Checking for updates...';
  resultDiv.style.color = 'var(--text-secondary)';
  updateBtn.style.display = 'none';

  fetch('/admin/check-update')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.error) {
        resultDiv.textContent = 'Could not check for updates.';
        resultDiv.style.color = 'var(--error)';
        return;
      }

      if (data.updateAvailable) {
        resultDiv.innerHTML = `
          <p style="color: var(--success); margin-bottom: 0.5rem;">
            ‚ú® <strong>Update available: v${data.latestVersion}</strong>
          </p>
          <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">
            ${data.releaseName || 'New version available'}
          </p>
        `;
        updateBtn.style.display = 'inline-block';
      } else {
        resultDiv.textContent = '‚úÖ You are running the latest version!';
        resultDiv.style.color = 'var(--success)';
      }
    })
    .catch(function() {
      resultDiv.textContent = 'Failed to check for updates.';
      resultDiv.style.color = 'var(--error)';
    });
}

function performAppUpdate() {
  var btn = document.getElementById('app-update-btn');
  var progressDiv = document.getElementById('app-update-progress');
  var progressBar = document.getElementById('app-progress-bar');
  var progressText = document.getElementById('app-progress-text');
  var resultDiv = document.getElementById('update-result');

  if (!confirm('Update and restart the server now?')) return;

  btn.disabled = true;
  btn.textContent = '‚è≥ Updating...';
  resultDiv.textContent = '';
  progressDiv.style.display = 'block';
  progressText.textContent = '';
  progressBar.style.width = '10%';

  var eventSource = new EventSource('/admin/app-update/stream');
  var progress = 10;

  eventSource.onmessage = function(e) {
    var data = JSON.parse(e.data);

    // Ignore keepalive pings
    if (data.type === 'ping') return;

    // Only show non-empty messages
    if (data.message) {
      progressText.textContent += data.message + '\n';
      progressText.scrollTop = progressText.scrollHeight;
    }

    if (data.type === 'progress') {
      progress = Math.min(progress + 10, 90);
      progressBar.style.width = progress + '%';
    } else if (data.type === 'complete') {
      progressBar.style.width = '100%';
      progressText.textContent += '\n‚úÖ Update complete! Reloading page...\n';
      setTimeout(function() {
        window.location.reload();
      }, 3000);
    } else if (data.type === 'restart') {
      progressBar.style.width = '95%';
      progressText.textContent += '\nüîÑ Server restarting... Page will reload in 5 seconds.\n';
      setTimeout(function() {
        window.location.reload();
      }, 5000);
    } else if (data.type === 'error') {
      progressBar.style.background = 'var(--error)';
      btn.disabled = false;
      btn.textContent = 'üöÄ Update Now';
    }
  };

  eventSource.onerror = function() {
    eventSource.close();
    // If we haven't reached 100%, it's a real error
    if (progress < 90) {
      progressText.textContent += '\n‚ùå Connection lost. Check server logs or try refreshing.\n';
      progressBar.style.background = 'var(--error)';
      btn.disabled = false;
      btn.textContent = 'üöÄ Update Now';
    } else {
      // If we're at 90%+, assume server is restarting
      progressText.textContent += '\nüîÑ Server restarting... Refreshing in 5 seconds.\n';
      setTimeout(function() {
        window.location.reload();
      }, 5000);
    }
  };
}

function loadDndDataStatus() {
  fetch('/admin/dnd-data/status')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var statusDiv = document.getElementById('dnd-data-status');
      if (data.last_import_date) {
        var date = new Date(data.last_import_date);
        statusDiv.innerHTML = `
          <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">
            <strong>Last Updated:</strong> ${date.toLocaleString()}
          </p>
          <p style="font-size: 0.85rem; color: var(--text-secondary);">
            ${data.spell_count || 0} spells ‚Ä¢ ${data.class_count || 0} classes ‚Ä¢ ${data.race_count || 0} races ‚Ä¢ ${data.item_count || 0} items
          </p>
        `;
      } else {
        statusDiv.innerHTML = '<p style="color: var(--warning);">‚ö†Ô∏è Library not initialized. Click Update to import data.</p>';
      }
    })
    .catch(function() {
      var statusDiv = document.getElementById('dnd-data-status');
      statusDiv.innerHTML = '<p style="color: var(--error);">Failed to load status.</p>';
    });
}

function updateDndData() {
  var btn = document.getElementById('update-dnd-btn');
  var progressDiv = document.getElementById('dnd-data-progress');
  var progressBar = document.getElementById('dnd-progress-bar');
  var progressText = document.getElementById('dnd-progress-text');

  btn.disabled = true;
  btn.textContent = '‚è≥ Updating...';
  progressDiv.style.display = 'block';
  progressText.textContent = '';
  progressBar.style.width = '0%';

  var eventSource = new EventSource('/admin/dnd-data/import-stream');
  var progress = 0;
  var totalSteps = 4; // spells, classes, races, items
  var completedSteps = 0;

  eventSource.onmessage = function(e) {
    var data = JSON.parse(e.data);

    progressText.textContent += data.message + '\n';
    progressText.scrollTop = progressText.scrollHeight;

    if (data.type === 'progress') {
      // Estimate progress based on output
      if (data.message.includes('‚úÖ Imported') && data.message.includes('total')) {
        completedSteps++;
        progress = (completedSteps / totalSteps) * 100;
        progressBar.style.width = progress + '%';
      }
    } else if (data.type === 'complete') {
      progressBar.style.width = '100%';
      eventSource.close();
      btn.disabled = false;
      btn.textContent = 'üîÑ Update Library';
      // Reload status
      setTimeout(loadDndDataStatus, 500);
    } else if (data.type === 'error') {
      progressBar.style.background = 'var(--error)';
      eventSource.close();
      btn.disabled = false;
      btn.textContent = 'üîÑ Update Library';
    }
  };

  eventSource.onerror = function() {
    eventSource.close();
    if (progress < 100) {
      progressText.textContent += '\n‚ùå Connection lost or import failed.\n';
      progressBar.style.background = 'var(--error)';
    }
    btn.disabled = false;
    btn.textContent = 'üîÑ Update Library';
  };
}

document.addEventListener('DOMContentLoaded', function() {
  loadCommsConfig();
  loadGoogleOAuthConfig();
  loadDndDataStatus();
});
</script>

<%- include('../partials/foot') %>
