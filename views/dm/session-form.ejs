<%- include('../partials/head', { pageTitle: 'New Quest Session' }) %>

<div class="page-header">
  <h1>Summon the Party</h1>
  <a href="/" class="btn btn-outline">Back to Chamber</a>
</div>

<% if (unavailabilities.length > 0) { %>
  <div class="card unavail-info-card">
    <h2>Adventurer Unavailability</h2>
    <p class="form-hint">These adventurers have marked dates they cannot play:</p>
    <div class="unavail-list">
      <% for (const u of unavailabilities) { %>
        <div class="unavail-item">
          <strong><%= u.username %></strong>
          <span class="unavail-date"><%= formatDate(u.date + 'T00:00:00', { weekday: 'short', month: 'short', day: 'numeric', showTime: false }) %></span>
          <% if (u.reason) { %>
            <span class="unavail-reason">&mdash; <%= u.reason %></span>
          <% } %>
        </div>
      <% } %>
    </div>
  </div>
<% } %>

<div class="card">
  <form action="/sessions" method="POST" id="session-form">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <!-- Quick Post: Title + Category Inline -->
    <div class="quick-post-header">
      <div class="form-group form-group-inline">
        <label for="title">Quest Title</label>
        <input type="text" id="title" name="title" required placeholder="e.g. The Mines of Phandelver - Session 5" autofocus>
      </div>
      <div class="form-group form-group-category">
        <label for="category">Category</label>
        <select id="category" name="category">
          <option value="dnd">üé≤ D&D</option>
          <option value="rpg">‚öîÔ∏è RPG</option>
          <option value="gamenight">üéÆ Game Night</option>
          <option value="casual">‚òï Casual</option>
        </select>
      </div>
    </div>

    <!-- Quick Post: First Time Slot with Smart Defaults -->
    <div class="form-group">
      <label>First Time Slot</label>
      <p class="form-hint">Click to pick date and time</p>
      <div id="slots-container">
        <div class="slot-row">
          <input type="text" class="datetime-input" id="first-slot-datetime" placeholder="Select date & time..." readonly required>
          <input type="hidden" name="slot_dates_date" id="first-slot-date">
          <input type="hidden" name="slot_dates_time" id="first-slot-time">
          <input type="text" name="slot_labels" placeholder="Label (optional, e.g. Evening)">
          <span class="remove-slot-placeholder"></span>
          <div class="slot-unavail-warning"></div>
        </div>
      </div>
      <button type="button" id="add-slot" class="btn btn-outline btn-small">+ Add Another Slot</button>
    </div>

    <!-- More Options (Collapsible) -->
    <details class="more-options">
      <summary>‚ñº More Options</summary>
      <div class="more-options-content">
        <div class="form-group">
          <label for="description">Quest Description (optional)</label>
          <textarea id="description" name="description" rows="3" placeholder="Brief description of the session..."></textarea>
        </div>

        <% if (typeof mapLocations !== 'undefined' && mapLocations.length > 0) { %>
        <div class="form-group">
          <label for="location_id">Location (optional)</label>
          <select id="location_id" name="location_id">
            <option value="">-- No location --</option>
            <% for (const loc of mapLocations) { %>
              <option value="<%= loc.id %>"><%= loc.map_name ? loc.map_name + ' ‚Äî ' : '' %><%= loc.name %></option>
            <% } %>
          </select>
        </div>
        <% } %>
      </div>
    </details>

    <button type="submit" class="btn btn-primary">Post to Tavern Board</button>
  </form>
</div>

<script>
  window.__unavailData = <%- JSON.stringify(unavailabilities.map(u => ({ date: u.date, username: u.username, reason: u.reason }))) %>;
  window.__timeFormat = '<%= (typeof user !== 'undefined' && user && user.time_format) ? user.time_format : '24h' %>';
  window.__weekStart = '<%= (typeof user !== 'undefined' && user && user.week_start) ? user.week_start : 'monday' %>';
</script>
<script src="/js/datetime-picker.js?v=<%= appVersion %>"></script>
<script src="/js/quick-post.js?v=<%= appVersion %>"></script>

<%- include('../partials/foot') %>
