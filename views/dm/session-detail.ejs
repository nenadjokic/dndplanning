<%- include('../partials/head', { pageTitle: session.title }) %>

<div class="page-header">
  <h1><%= session.title %></h1>
  <a href="/" class="btn btn-outline">Back to Chamber</a>
</div>

<div class="card">
  <div class="session-status-badge session-status-badge-lg"><%= session.status %></div>
  <% if (session.description) { %>
    <p class="session-desc"><%= session.description %></p>
  <% } %>

  <% if (session.status === 'confirmed') { %>
    <% const confirmedSlot = slots.find(s => s.id === session.confirmed_slot_id); %>
    <% if (confirmedSlot) { %>
      <div class="confirmed-banner">
        <h3>Quest Date Proclaimed!</h3>
        <p>
          <%= formatDate(confirmedSlot.date_time, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) %>
          <% if (confirmedSlot.label) { %> &mdash; <%= confirmedSlot.label %><% } %>
        </p>
      </div>
    <% } %>
  <% } %>

  <% if (Object.keys(preferenceMap).length > 0) { %>
    <div class="preference-display">
      <h3>DM / Admin Preferences</h3>
      <% for (const uid in preferenceMap) { %>
        <% const pref = preferenceMap[uid]; %>
        <% const prefSlot = slots.find(s => s.id === pref.slot_id); %>
        <% if (prefSlot) { %>
          <p class="preference-entry">
            <% if (typeof allUsersMap !== 'undefined' && allUsersMap[uid] && allUsersMap[uid].avatar) { %>
              <img src="/avatars/<%= allUsersMap[uid].avatar %>" alt="" class="avatar-tiny">
            <% } %>
            <strong><%= pref.username %></strong> prefers:
            <%= formatDate(prefSlot.date_time, { weekday: 'short', month: 'short', day: 'numeric' }) %>
            <% if (prefSlot.label) { %> &mdash; <%= prefSlot.label %><% } %>
          </p>
        <% } %>
      <% } %>
    </div>
  <% } %>

  <h2>Party Availability</h2>
  <% if (players.length === 0) { %>
    <p class="empty-state-text">No adventurers have joined the guild yet.</p>
  <% } else { %>
    <%- include('../partials/slot-grid', { slots, players, voteMap, slotSummary, preferenceMap, allUsersMap: typeof allUsersMap !== 'undefined' ? allUsersMap : {}, unavailabilityMap: typeof unavailabilityMap !== 'undefined' ? unavailabilityMap : undefined }) %>
  <% } %>

  <% if (session.status === 'open') { %>
    <div class="dm-actions">
      <h3>Your Preferred Date</h3>
      <form action="/sessions/<%= session.id %>/prefer" method="POST" class="confirm-form">
        <div class="form-group">
          <label for="prefer_slot_id">Choose your preferred slot:</label>
          <select name="slot_id" id="prefer_slot_id">
            <option value="">-- No preference --</option>
            <% for (const slot of slots) { %>
              <option value="<%= slot.id %>" <%= myPreference && myPreference.slot_id === slot.id ? 'selected' : '' %>>
                <%= formatDate(slot.date_time, { weekday: 'short', month: 'short', day: 'numeric' }) %>
                <% if (slot.label) { %> - <%= slot.label %><% } %>
              </option>
            <% } %>
          </select>
        </div>
        <button type="submit" class="btn btn-outline">Set Preference</button>
      </form>
    </div>

    <div class="dm-actions">
      <h3>Proclaim a Quest Date</h3>
      <form action="/sessions/<%= session.id %>/confirm" method="POST" class="confirm-form">
        <div class="form-group">
          <label for="slot_id">Choose the time slot:</label>
          <select name="slot_id" id="slot_id" required>
            <option value="">-- Select a slot --</option>
            <% for (const slot of slots) { %>
              <option value="<%= slot.id %>">
                <%= formatDate(slot.date_time, { weekday: 'short', month: 'short', day: 'numeric' }) %>
                <% if (slot.label) { %> - <%= slot.label %><% } %>
                (<%= slotSummary[slot.id].available %> available)
              </option>
            <% } %>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Proclaim This Date</button>
      </form>
      <form action="/sessions/<%= session.id %>/cancel" method="POST" class="inline-form" style="margin-top: 1rem;">
        <button type="submit" class="btn btn-danger" onclick="return confirm('Cancel this quest?')">Cancel Quest</button>
      </form>
    </div>
  <% } else { %>
    <div class="dm-actions">
      <form action="/sessions/<%= session.id %>/reopen" method="POST" class="inline-form">
        <button type="submit" class="btn btn-outline">Reopen Quest Board</button>
      </form>
    </div>
  <% } %>

  <% if (user && user.role === 'admin') { %>
    <div class="dm-actions">
      <form action="/sessions/<%= session.id %>/delete" method="POST" class="inline-form">
        <button type="submit" class="btn btn-danger" onclick="return confirm('Permanently delete this quest and all associated data? This cannot be undone.')">Delete Quest</button>
      </form>
    </div>
  <% } %>
</div>

<%- include('../partials/foot') %>
