<%- include('../partials/head', { pageTitle: session.title }) %>

<div class="page-header">
  <h1><%= session.title %></h1>
  <a href="/" class="btn btn-outline">Back to Quest Board</a>
</div>

<div class="card">
  <span class="session-category"><%= session.category === 'gamenight' ? 'Game Night' : session.category === 'rpg' ? 'RPG' : session.category === 'casual' ? 'Casual' : 'D&D' %></span>
  <div class="session-status-badge session-status-badge-lg"><%= session.status %></div>
  <% if (session.description) { %>
    <p class="session-desc"><%= session.description %></p>
  <% } %>
  <% if (typeof locationName !== 'undefined' && locationName) { %>
    <p class="session-meta" style="margin-bottom: 0.5rem;">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
      <a href="/map"><%= locationName %></a>
    </p>
  <% } %>

  <% if (session.status === 'confirmed' || session.status === 'completed') { %>
    <% const confirmedSlot = slots.find(s => s.id === session.confirmed_slot_id); %>
    <% if (confirmedSlot) { %>
      <div class="confirmed-banner">
        <h3><%= session.status === 'completed' ? 'Quest Completed!' : 'Quest Date Proclaimed!' %></h3>
        <p>
          <%= formatDate(confirmedSlot.date_time, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) %>
          <% if (confirmedSlot.label) { %> &mdash; <%= confirmedSlot.label %><% } %>
        </p>
      </div>
    <% } %>
  <% } %>

  <% if (session.status === 'completed' && session.summary) { %>
    <div class="recap-card">
      <h3>Session Recap</h3>
      <div class="recap-text recap-rendered"><%- renderMarkdown(session.summary) %></div>
    </div>
  <% } %>

  <% if (session.status === 'open') { %>
    <h2>Cast Your Availability</h2>
    <form action="/votes/<%= session.id %>" method="POST">
      <div class="vote-slots">
        <% for (const slot of slots) { %>
          <div class="vote-slot-card">
            <div class="vote-slot-header">
              <div class="slot-date"><%= formatDate(slot.date_time, { weekday: 'long', month: 'long', day: 'numeric', showTime: false }) %></div>
              <div class="slot-time"><%= formatTime(slot.date_time) %></div>
              <% if (slot.label) { %><div class="slot-label"><%= slot.label %></div><% } %>
            </div>
            <div class="vote-options">
              <label class="vote-option vote-available">
                <input type="radio" name="vote_<%= slot.id %>" value="available" <%= myVotes[slot.id] === 'available' ? 'checked' : '' %>>
                <span class="vote-icon">&#10003;</span> Available
              </label>
              <label class="vote-option vote-maybe">
                <input type="radio" name="vote_<%= slot.id %>" value="maybe" <%= myVotes[slot.id] === 'maybe' ? 'checked' : '' %>>
                <span class="vote-icon">?</span> Maybe
              </label>
              <label class="vote-option vote-unavailable">
                <input type="radio" name="vote_<%= slot.id %>" value="unavailable" <%= myVotes[slot.id] === 'unavailable' ? 'checked' : '' %>>
                <span class="vote-icon">&#10007;</span> Unavailable
              </label>
            </div>
          </div>
        <% } %>
      </div>
      <button type="submit" class="btn btn-primary" onclick="return confirm('Submit your availability for this quest?')">Submit Availability</button>
    </form>
  <% } else { %>
    <h2>Your Votes</h2>
    <div class="vote-slots">
      <% for (const slot of slots) { %>
        <div class="vote-slot-card">
          <div class="vote-slot-header">
            <div class="slot-date"><%= formatDate(slot.date_time, { weekday: 'long', month: 'long', day: 'numeric', showTime: false }) %></div>
            <div class="slot-time"><%= formatTime(slot.date_time) %></div>
            <% if (slot.label) { %><div class="slot-label"><%= slot.label %></div><% } %>
          </div>
          <div class="vote-result vote-<%= myVotes[slot.id] || 'none' %>">
            <% if (myVotes[slot.id] === 'available') { %>
              &#10003; Available
            <% } else if (myVotes[slot.id] === 'maybe') { %>
              ? Maybe
            <% } else if (myVotes[slot.id] === 'unavailable') { %>
              &#10007; Unavailable
            <% } else { %>
              &mdash; No vote
            <% } %>
          </div>
        </div>
      <% } %>
    </div>
  <% } %>
</div>

<%- include('../partials/comments', { session, sessionPosts, sessionReplyMap }) %>

<%- include('../partials/foot') %>
