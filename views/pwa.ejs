<%- include('partials/head', { pageTitle: 'Install App' }) %>

<div class="page-header">
  <h1>Install Quest Planner</h1>
  <a href="/" class="btn btn-outline">Back to Chamber</a>
</div>

<div class="card">
  <h2>What is a PWA?</h2>
  <p>Quest Planner is a Progressive Web App (PWA). You can install it directly from your browser to get a native app-like experience &mdash; no app store needed!</p>
  <p>Once installed, Quest Planner will:</p>
  <ul class="pwa-benefits">
    <li>Appear as an app on your home screen / desktop</li>
    <li>Open in its own window (no browser chrome)</li>
    <li>Show an offline page when you lose connection</li>
    <li>Load faster with cached assets</li>
  </ul>
</div>

<div class="card" style="margin-top: 1.5rem;">
  <h2>Installation Instructions</h2>

  <div class="pwa-platform">
    <h3>Android (Chrome)</h3>
    <ol>
      <li>Open Quest Planner in <strong>Chrome</strong></li>
      <li>Tap the <strong>three-dot menu</strong> (top right)</li>
      <li>Tap <strong>"Install app"</strong> or <strong>"Add to Home screen"</strong></li>
      <li>Confirm by tapping <strong>"Install"</strong></li>
      <li>The app icon will appear on your home screen</li>
    </ol>
  </div>

  <div class="pwa-platform">
    <h3>iPhone / iPad (Safari)</h3>
    <ol>
      <li>Open Quest Planner in <strong>Safari</strong> (required &mdash; other browsers won't work)</li>
      <li>Tap the <strong>Share button</strong> (square with arrow at the bottom)</li>
      <li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
      <li>Tap <strong>"Add"</strong> in the top right</li>
      <li>The app icon will appear on your home screen</li>
    </ol>
    <p class="form-hint">Note: iOS 16.4+ is required for full PWA support.</p>
  </div>

  <div class="pwa-platform">
    <h3>Desktop (Chrome / Edge)</h3>
    <ol>
      <li>Open Quest Planner in <strong>Chrome</strong> or <strong>Edge</strong></li>
      <li>Look for the <strong>install icon</strong> in the address bar (monitor with down arrow)</li>
      <li>Click it and confirm <strong>"Install"</strong></li>
      <li>The app will open in its own window and appear in your app launcher</li>
    </ol>
  </div>

  <div class="pwa-platform">
    <h3>Desktop (Firefox)</h3>
    <p class="text-muted">Firefox does not support PWA installation on desktop. Use Chrome or Edge instead.</p>
  </div>
</div>

<div class="card" style="margin-top: 1.5rem;">
  <h2>Push Notifications</h2>
  <p>Get notified on your device when quests are created, confirmed, completed, or cancelled.</p>
  <div id="push-status">
    <p id="push-status-text" class="text-muted">Checking push notification support...</p>
    <button type="button" class="btn btn-primary btn-small" id="push-enable-btn" style="display:none;">Enable Push Notifications</button>
    <button type="button" class="btn btn-outline btn-small" id="push-disable-btn" style="display:none;">Disable Push Notifications</button>
  </div>
  <div class="pwa-platform" style="margin-top: 1rem;">
    <p class="form-hint"><strong>Requirements:</strong> Push notifications require HTTPS and a supported browser. On iOS, you must first install the app to your home screen (see instructions above), then enable notifications from within the installed app.</p>
  </div>
  <div class="pwa-platform" style="margin-top: 1rem;">
    <h3>iOS Troubleshooting</h3>
    <p class="form-hint">If push notifications show as enabled but you don't receive them on iPhone/iPad:</p>
    <ol>
      <li>Make sure you installed the app from <strong>Safari</strong> (Add to Home Screen)</li>
      <li>Open the app from your <strong>home screen</strong>, not from Safari</li>
      <li>Go to <strong>iOS Settings &gt; Notifications &gt; Quest Planner</strong> and make sure notifications are allowed</li>
      <li>Check that <strong>Focus mode</strong> (Do Not Disturb) is not blocking notifications</li>
      <li>If still not working: disable notifications here, close the app completely, reopen it, and re-enable</li>
    </ol>
  </div>
</div>

<div class="card" style="margin-top: 1.5rem;">
  <h2>App Status</h2>
  <div id="pwa-status">
    <p id="pwa-installed-status" class="text-muted">Checking installation status...</p>
    <button type="button" class="btn btn-primary" id="pwa-install-btn" style="display:none;">Install Quest Planner</button>
  </div>
</div>

<script>
(function() {
  var installBtn = document.getElementById('pwa-install-btn');
  var statusText = document.getElementById('pwa-installed-status');
  var deferredPrompt = null;

  // Check if already installed
  if (window.matchMedia('(display-mode: standalone)').matches) {
    statusText.textContent = 'Quest Planner is installed and running as an app!';
    statusText.style.color = 'var(--green-light)';
    return;
  }

  statusText.textContent = 'Quest Planner is not installed yet. Use the instructions above or click the button below.';

  window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-block';
  });

  installBtn.addEventListener('click', function() {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(function(choice) {
      if (choice.outcome === 'accepted') {
        statusText.textContent = 'Quest Planner has been installed!';
        statusText.style.color = 'var(--green-light)';
        installBtn.style.display = 'none';
      }
      deferredPrompt = null;
    });
  });

  window.addEventListener('appinstalled', function() {
    statusText.textContent = 'Quest Planner is installed and running as an app!';
    statusText.style.color = 'var(--green-light)';
    installBtn.style.display = 'none';
  });
})();

// Push notifications
(function() {
  var pushText = document.getElementById('push-status-text');
  var enableBtn = document.getElementById('push-enable-btn');
  var disableBtn = document.getElementById('push-disable-btn');
  var vapidPublicKey = '<%= typeof vapidPublicKey !== "undefined" && vapidPublicKey ? vapidPublicKey : "" %>';

  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    pushText.textContent = 'Push notifications are not supported in this browser.';
    return;
  }

  if (!vapidPublicKey) {
    pushText.textContent = 'Push notifications are not configured on this server.';
    return;
  }

  function urlBase64ToUint8Array(base64String) {
    var padding = '='.repeat((4 - base64String.length % 4) % 4);
    var base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    var rawData = window.atob(base64);
    var outputArray = new Uint8Array(rawData.length);
    for (var i = 0; i < rawData.length; i++) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  }

  navigator.serviceWorker.ready.then(function(registration) {
    return registration.pushManager.getSubscription().then(function(sub) {
      if (sub) {
        pushText.textContent = 'Push notifications are enabled!';
        pushText.style.color = 'var(--green-light)';
        disableBtn.style.display = 'inline-block';
      } else {
        pushText.textContent = 'Push notifications are not enabled.';
        enableBtn.style.display = 'inline-block';
      }
    });
  });

  enableBtn.addEventListener('click', function() {
    Notification.requestPermission().then(function(permission) {
      if (permission !== 'granted') {
        pushText.textContent = 'Notification permission denied. Please allow notifications in your browser settings.';
        pushText.style.color = 'var(--red-light)';
        return;
      }
      navigator.serviceWorker.ready.then(function(registration) {
        return registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
        });
      }).then(function(sub) {
        return fetch('/api/push/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subscription: sub })
        });
      }).then(function(resp) {
        return resp.json();
      }).then(function(data) {
        if (data.success) {
          pushText.textContent = 'Push notifications are enabled!';
          pushText.style.color = 'var(--green-light)';
          enableBtn.style.display = 'none';
          disableBtn.style.display = 'inline-block';
        }
      }).catch(function(err) {
        pushText.textContent = 'Failed to enable push notifications: ' + err.message;
        pushText.style.color = 'var(--red-light)';
      });
    });
  });

  disableBtn.addEventListener('click', function() {
    navigator.serviceWorker.ready.then(function(registration) {
      return registration.pushManager.getSubscription();
    }).then(function(sub) {
      if (sub) {
        var endpoint = sub.endpoint;
        return sub.unsubscribe().then(function() {
          return fetch('/api/push/unsubscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ endpoint: endpoint })
          });
        });
      }
    }).then(function() {
      pushText.textContent = 'Push notifications are disabled.';
      pushText.style.color = '';
      disableBtn.style.display = 'none';
      enableBtn.style.display = 'inline-block';
    });
  });
})();
</script>

<%- include('partials/foot') %>
