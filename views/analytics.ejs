<%- include('partials/head', { pageTitle: 'Guild Analytics' }) %>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

<div class="page-header">
  <h1>Guild Analytics</h1>
  <a href="/" class="btn btn-outline">Back to Chamber</a>
</div>

<% const data = analyticsData; %>

<!-- ============== SECTION 1: Overview Stats ============== -->
<div class="analytics-section-title">Overview</div>
<div class="analytics-stats">
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number"><%= data.totalSessions %></div>
    <div class="analytics-stat-label">Total Sessions</div>
  </div>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number" style="color: var(--green-light);"><%= data.completedSessions %></div>
    <div class="analytics-stat-label">Completed</div>
  </div>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number" style="color: var(--red-light);"><%= data.cancelledSessions %></div>
    <div class="analytics-stat-label">Cancelled</div>
  </div>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number"><%= data.avgPlayers %></div>
    <div class="analytics-stat-label">Avg Players</div>
  </div>
</div>

<!-- Streak + Guild Age + Completion Rate -->
<div class="analytics-stats" style="margin-top: 0.75rem;">
  <div class="card analytics-stat-card">
    <% if (data.streak > 0) { %>
      <div class="analytics-stat-number" style="color: #e67e22;">&#128293; <%= data.streak %></div>
      <div class="analytics-stat-label">Week Streak</div>
    <% } else { %>
      <div class="analytics-stat-number" style="font-size: 1rem;">No active streak</div>
      <div class="analytics-stat-label">Week Streak</div>
    <% } %>
  </div>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number"><%= data.completionRate %>%</div>
    <div class="analytics-stat-label">Completion Rate</div>
  </div>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number"><%= data.guildAgeDays %></div>
    <div class="analytics-stat-label">Days Since Founded</div>
  </div>
  <% if (data.longestDrought) { %>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number" style="color: var(--red-light);"><%= data.longestDrought.days %></div>
    <div class="analytics-stat-label">Longest Drought (days)</div>
  </div>
  <% } %>
</div>

<!-- ============== SECTION 2: Charts ============== -->
<div class="analytics-section-title">Session Trends</div>
<div class="analytics-charts-row">
  <div class="card analytics-chart-card">
    <h2>Sessions per Month</h2>
    <canvas id="chart-monthly"></canvas>
  </div>
  <div class="card analytics-chart-card">
    <h2>Preferred Day</h2>
    <canvas id="chart-days"></canvas>
  </div>
</div>

<div class="analytics-charts-row" style="margin-top: 1rem;">
  <div class="card analytics-chart-card">
    <h2>Session Status</h2>
    <div style="max-width: 260px; margin: 0 auto;">
      <canvas id="chart-completion"></canvas>
    </div>
  </div>
  <% if (data.categoryBreakdown.length > 0) { %>
  <div class="card analytics-chart-card">
    <h2>Category Breakdown</h2>
    <div style="max-width: 260px; margin: 0 auto;">
      <canvas id="chart-categories"></canvas>
    </div>
  </div>
  <% } %>
</div>

<!-- ============== SECTION 3: Member Attendance ============== -->
<% if (data.attendance.length > 0) { %>
<div class="analytics-section-title">Member Attendance</div>
<div class="card analytics-chart-card">
  <h2>Attendance (%)</h2>
  <canvas id="chart-attendance"></canvas>
</div>
<% } %>

<!-- ============== SECTION 4: Vote Heatmap ============== -->
<% if (data.heatmap.sessions.length > 0 && data.heatmap.users.length > 0) { %>
<div class="analytics-section-title">Vote Heatmap</div>
<div class="card" style="overflow-x: auto;">
  <table class="analytics-heatmap">
    <thead>
      <tr>
        <th>Member</th>
        <% for (const s of data.heatmap.sessions) { %>
          <th title="<%= s.title %>"><%= s.title.substring(0, 8) %></th>
        <% } %>
      </tr>
    </thead>
    <tbody>
      <% for (const u of data.heatmap.users) { %>
        <tr>
          <td class="heatmap-username"><%= u.username %></td>
          <% for (const v of u.votes) { %>
            <td class="heatmap-cell heatmap-<%= v || 'none' %>">
              <% if (v === 'available') { %>&#10003;<% } else if (v === 'maybe') { %>?<% } else if (v === 'unavailable') { %>&#10007;<% } else { %>-<% } %>
            </td>
          <% } %>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>
<% } %>

<!-- ============== SECTION 5: Member Awards ============== -->
<div class="analytics-section-title">Member Awards</div>
<div class="analytics-stats">
  <% if (data.topAccepter) { %>
  <div class="card analytics-stat-card">
    <div class="analytics-award-icon">&#9989;</div>
    <div class="analytics-stat-label" style="margin-bottom: 0.3rem;">Most Accepting</div>
    <div class="analytics-stat-number" style="font-size: 1.2rem; color: var(--green-light);"><%= data.topAccepter.username %></div>
    <div class="analytics-stat-sublabel"><%= data.topAccepter.accept_pct %>% accept rate (<%= data.topAccepter.accepts %>/<%= data.topAccepter.total_votes %>)</div>
  </div>
  <% } %>

  <% if (data.mostActive) { %>
  <div class="card analytics-stat-card">
    <div class="analytics-award-icon">&#9889;</div>
    <div class="analytics-stat-label" style="margin-bottom: 0.3rem;">Most Active</div>
    <div class="analytics-stat-number" style="font-size: 1.2rem; color: var(--gold);"><%= data.mostActive.username %></div>
    <div class="analytics-stat-sublabel"><%= data.mostActive.total_activity %> actions</div>
    <div class="analytics-stat-sublabel" style="font-size: 0.7rem; margin-top: 0.15rem;">
      <%= data.mostActive.posts %>p &middot; <%= data.mostActive.replies %>r &middot; <%= data.mostActive.comments %>c &middot; <%= data.mostActive.votes %>v
    </div>
  </div>
  <% } %>

  <% if (data.topDecliner) { %>
  <div class="card analytics-stat-card">
    <div class="analytics-award-icon">&#10060;</div>
    <div class="analytics-stat-label" style="margin-bottom: 0.3rem;">Most Declines</div>
    <div class="analytics-stat-number" style="font-size: 1.2rem; color: var(--red-light);"><%= data.topDecliner.username %></div>
    <div class="analytics-stat-sublabel"><%= data.topDecliner.declines %> unavailable (<%= data.topDecliner.decline_pct %>%)</div>
  </div>
  <% } %>

  <% if (data.fastestVoter) { %>
  <div class="card analytics-stat-card">
    <div class="analytics-award-icon">&#9201;</div>
    <div class="analytics-stat-label" style="margin-bottom: 0.3rem;">Fastest Voter</div>
    <div class="analytics-stat-number" style="font-size: 1.2rem; color: #3498db;"><%= data.fastestVoter.username %></div>
    <div class="analytics-stat-sublabel">Avg <%= data.fastestVoter.avgHours %> hrs to vote</div>
  </div>
  <% } %>
</div>

<!-- ============== SECTION 6: Extra Stats ============== -->
<div class="analytics-stats" style="margin-top: 0.75rem;">
  <% if (data.avgResponseTime) { %>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number"><%= data.avgResponseTime %> hrs</div>
    <div class="analytics-stat-label">Avg Response Time</div>
    <div class="analytics-stat-sublabel">Time to first vote</div>
  </div>
  <% } %>

  <% if (data.popularCategory) { %>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number" style="font-size: 1.2rem; color: var(--gold);"><%= data.popularCategory.category %></div>
    <div class="analytics-stat-label">Most Popular Category</div>
    <div class="analytics-stat-sublabel"><%= data.popularCategory.count %> sessions</div>
  </div>
  <% } %>
</div>

<!-- ============== SECTION 7: Bulletin Board Stats ============== -->
<% if (data.boardStats.totalPosts > 0) { %>
<div class="analytics-section-title">Bulletin Board</div>
<div class="analytics-stats">
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number"><%= data.boardStats.totalPosts %></div>
    <div class="analytics-stat-label">Total Topics</div>
  </div>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number"><%= data.boardStats.totalReplies %></div>
    <div class="analytics-stat-label">Total Replies</div>
  </div>
  <% if (data.boardStats.topPoster) { %>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number" style="font-size: 1.2rem; color: var(--gold);"><%= data.boardStats.topPoster.username %></div>
    <div class="analytics-stat-label">Top Poster</div>
    <div class="analytics-stat-sublabel"><%= data.boardStats.topPoster.post_count %> topics</div>
  </div>
  <% } %>
  <% if (data.boardStats.mostRepliedTopic) { %>
  <div class="card analytics-stat-card">
    <div class="analytics-stat-number" style="font-size: 1rem; color: var(--gold);"><%= data.boardStats.mostRepliedTopic.title %>...</div>
    <div class="analytics-stat-label">Hottest Topic</div>
    <div class="analytics-stat-sublabel"><%= data.boardStats.mostRepliedTopic.reply_count %> replies</div>
  </div>
  <% } %>
</div>
<% } %>

<script>
(function() {
  var data = <%- JSON.stringify(analyticsData) %>;
  var gold = '#d4a843';
  var green = '#27ae60';
  var red = '#c0392b';
  var blue = '#3498db';
  var orange = '#e67e22';
  var textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#a8a5a0';

  var defaultOpts = {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { color: textColor }, grid: { color: 'rgba(255,255,255,0.05)' } },
      y: { ticks: { color: textColor, precision: 0 }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true }
    }
  };

  // Monthly chart
  new Chart(document.getElementById('chart-monthly'), {
    type: 'bar',
    data: {
      labels: data.months.map(function(m) { return m.month; }),
      datasets: [{ data: data.months.map(function(m) { return m.count; }), backgroundColor: gold, borderRadius: 4 }]
    },
    options: defaultOpts
  });

  // Day of week chart
  new Chart(document.getElementById('chart-days'), {
    type: 'bar',
    data: {
      labels: data.days.map(function(d) { return d.day; }),
      datasets: [{ data: data.days.map(function(d) { return d.count; }), backgroundColor: green, borderRadius: 4 }]
    },
    options: defaultOpts
  });

  // Session status donut
  var completionCanvas = document.getElementById('chart-completion');
  if (completionCanvas) {
    new Chart(completionCanvas, {
      type: 'doughnut',
      data: {
        labels: ['Completed', 'Cancelled', 'Open'],
        datasets: [{
          data: [data.completionData.completed, data.completionData.cancelled, data.completionData.open],
          backgroundColor: [green, red, gold],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true, position: 'bottom', labels: { color: textColor, padding: 12 } }
        }
      }
    });
  }

  // Category breakdown donut
  var catCanvas = document.getElementById('chart-categories');
  if (catCanvas && data.categoryBreakdown.length > 0) {
    var catColors = [gold, green, blue, orange, red, '#9b59b6', '#1abc9c', '#e74c3c'];
    new Chart(catCanvas, {
      type: 'doughnut',
      data: {
        labels: data.categoryBreakdown.map(function(c) { return c.category; }),
        datasets: [{
          data: data.categoryBreakdown.map(function(c) { return c.count; }),
          backgroundColor: catColors.slice(0, data.categoryBreakdown.length),
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true, position: 'bottom', labels: { color: textColor, padding: 12 } }
        }
      }
    });
  }

  // Attendance chart
  var attCanvas = document.getElementById('chart-attendance');
  if (attCanvas && data.attendance.length > 0) {
    new Chart(attCanvas, {
      type: 'bar',
      data: {
        labels: data.attendance.map(function(a) { return a.username; }),
        datasets: [{ data: data.attendance.map(function(a) { return a.pct; }), backgroundColor: gold, borderRadius: 4 }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: textColor, callback: function(v) { return v + '%'; } }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true, max: 100 },
          y: { ticks: { color: textColor }, grid: { color: 'rgba(255,255,255,0.05)' } }
        }
      }
    });
  }
})();
</script>

<%- include('partials/foot') %>
